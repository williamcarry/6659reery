<template>
  <div class="image-upload-container">
    <!-- 只读模式：只显示图片 -->
    <div v-if="disabled && imageUrl" class="readonly-image">
      <img :src="imageUrl" :alt="label" class="display-image" />
    </div>
    
    <!-- 编辑模式 -->
    <template v-else>
      <div v-if="!imageUrl" class="upload-area" @click="triggerFileInput">
        <input
          ref="fileInput"
          type="file"
          accept="image/*"
          style="display: none"
          @change="handleFileSelect"
        />
        <div class="upload-content">
          <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="17 8 12 3 7 8"></polyline>
            <line x1="12" y1="3" x2="12" y2="15"></line>
          </svg>
          <p class="upload-text">点击上传图片</p>
          <p class="upload-hint">或拖拽图片到此</p>
        </div>
      </div>

      <div v-else class="preview-area">
        <img :src="imageUrl" :alt="label" class="preview-image" />
        <div class="preview-actions">
          <button
            type="button"
            class="btn-secondary"
            @click="removeImage"
          >
            删除
          </button>
        </div>
      </div>
    </template>

    <div v-if="uploading" class="upload-progress">
      <div class="progress-bar">
        <div class="progress-bar-fill" :style="{ width: uploadProgress + '%' }"></div>
      </div>
      <span class="progress-text">上传中... {{ uploadProgress }}%</span>
    </div>

    <div v-if="errorMessage" class="error-message">
      {{ errorMessage }}
    </div>
  </div>
</template>

<script setup>
import { ref, watch } from 'vue'
import apiSignature from '../services/apiSignature.js'

const props = defineProps({
  modelValue: {
    type: String,
    default: '',
  },
  label: {
    type: String,
    required: true,
  },
  disabled: {
    type: Boolean,
    default: false,
  },
})

const emit = defineEmits(['update:modelValue', 'upload-success'])

const fileInput = ref(null)
const imageUrl = ref(props.modelValue)
const imageKey = ref(props.modelValue) // 存储原始key
const uploading = ref(false)
const uploadProgress = ref(0)
const errorMessage = ref('')

// 监听modelValue变化
watch(
  () => props.modelValue,
  async (newVal) => {
    if (newVal) {
      imageKey.value = newVal
      // 如果是key，需要解析成URL
      if (!newVal.startsWith('http')) {
        await parseImageUrl(newVal)
      } else {
        imageUrl.value = newVal
      }
    }
  }
)

// 解析图片URL
const parseImageUrl = async (key) => {
  try {
    const signedData = apiSignature.sign({ key })
    
    const response = await fetch('/shop/api/upload/parse-image', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        key,
        timestamp: signedData.timestamp,
        nonce: signedData.nonce,
        signature: signedData.signature
      }),
      credentials: 'include'
    })
    
    const result = await response.json()
    
    if (result.success) {
      imageUrl.value = result.url
    } else {
      console.error('解析图片URL失败:', result.message)
    }
  } catch (error) {
    console.error('解析图片URL异常:', error)
  }
}

const triggerFileInput = () => {
  fileInput.value?.click()
}

const handleFileSelect = async (event) => {
  const file = event.target.files?.[0]
  if (!file) return

  if (!file.type.startsWith('image/')) {
    errorMessage.value = '请选择图片文件'
    return
  }

  if (file.size > 10 * 1024 * 1024) {
    errorMessage.value = '文件大小不能超过10MB'
    return
  }

  errorMessage.value = ''

  // 本地预览
  const reader = new FileReader()
  reader.onload = (e) => {
    imageUrl.value = e.target?.result || ''
  }
  reader.readAsDataURL(file)

  // 上传到七牛云
  await uploadToQiniu(file)
}

const uploadToQiniu = async (file) => {
  uploading.value = true
  uploadProgress.value = 0

  try {
    const formData = new FormData()
    formData.append('file', file)
    
    // 生成签名
    const signedData = apiSignature.sign({})
    formData.append('timestamp', signedData.timestamp)
    formData.append('nonce', signedData.nonce)
    formData.append('signature', signedData.signature)

    const xhr = new XMLHttpRequest()

    xhr.upload.addEventListener('progress', (e) => {
      if (e.lengthComputable) {
        uploadProgress.value = Math.round((e.loaded / e.total) * 100)
      }
    })

    xhr.addEventListener('load', () => {
      if (xhr.status === 200) {
        const response = JSON.parse(xhr.responseText)
        
        if (response.success) {
          // 存储key和预览URL
          imageKey.value = response.key
          imageUrl.value = response.previewUrl
          
          // 通知父组件，传递key（用于保存到数据库）
          emit('update:modelValue', response.key)
          emit('upload-success', {
            key: response.key,
            previewUrl: response.previewUrl
          })
          
          uploading.value = false
          errorMessage.value = ''
        } else {
          errorMessage.value = response.message || '上传失败，请重试'
          uploading.value = false
        }
      } else {
        errorMessage.value = '上传失败，请重试'
        uploading.value = false
      }
    })

    xhr.addEventListener('error', () => {
      errorMessage.value = '上传出错，请重试'
      uploading.value = false
    })

    xhr.addEventListener('abort', () => {
      errorMessage.value = '上传已取消'
      uploading.value = false
    })

    xhr.open('POST', '/shop/api/upload/image')
    xhr.send(formData)
  } catch (error) {
    errorMessage.value = error.message || '上传失败'
    uploading.value = false
    console.error('上传失败:', error)
  }
}

const removeImage = () => {
  imageUrl.value = ''
  imageKey.value = ''
  emit('update:modelValue', '')
  if (fileInput.value) {
    fileInput.value.value = ''
  }
}
</script>

<style scoped>
.image-upload-container {
  width: 100%;
}

.upload-area {
  border: 2px dashed #d0d7de;
  border-radius: 8px;
  padding: 32px;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s ease;
  background-color: #f6f8fa;
}

.upload-area:hover {
  border-color: #CB261C;
  background-color: #fff5f5;
}

.upload-icon {
  width: 48px;
  height: 48px;
  margin: 0 auto 16px;
  color: #57606a;
}

.upload-text {
  font-size: 14px;
  font-weight: 500;
  color: #24292f;
  margin: 0 0 4px 0;
}

.upload-hint {
  font-size: 12px;
  color: #57606a;
  margin: 0;
}

.preview-area {
  position: relative;
  display: inline-block;
  width: 100%;
}

.preview-image {
  max-width: 100%;
  max-height: 300px;
  border-radius: 8px;
  border: 1px solid #d0d7de;
  cursor: pointer;
  transition: opacity 0.3s ease;
}

.preview-image:hover {
  opacity: 0.8;
}

.preview-actions {
  display: flex;
  gap: 8px;
  margin-top: 12px;
}

.btn-primary,
.btn-secondary {
  padding: 8px 16px;
  border-radius: 6px;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.3s ease;
  border: none;
  outline: none;
}

.btn-primary {
  background-color: #CB261C;
  color: white;
}

.btn-primary:hover {
  background-color: #a61e16;
}

.btn-secondary {
  background-color: #f6f8fa;
  color: #24292f;
  border: 1px solid #d0d7de;
}

.btn-secondary:hover {
  background-color: #f3f4f6;
}

.upload-progress {
  margin-top: 12px;
}

.progress-bar {
  width: 100%;
  height: 8px;
  background-color: #f3f4f6;
  border-radius: 4px;
  overflow: hidden;
}

.progress-bar-fill {
  height: 100%;
  background-color: #CB261C;
  transition: width 0.3s ease;
}

.progress-text {
  display: block;
  font-size: 12px;
  color: #57606a;
  margin-top: 4px;
}

.error-message {
  color: #d1242f;
  font-size: 12px;
  margin-top: 8px;
}

.readonly-image {
  width: 100%;
}

.display-image {
  max-width: 100%;
  max-height: 300px;
  border-radius: 8px;
  border: 1px solid #d0d7de;
}
</style>
