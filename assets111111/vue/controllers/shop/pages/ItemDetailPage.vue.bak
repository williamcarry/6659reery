<script setup>
import { ref, computed, onMounted, onBeforeUnmount, watch } from 'vue'
import { Check, X, ChevronRight } from 'lucide-vue-next'
import { ElMessage, ElMessageBox } from 'element-plus'
import SiteHeader from '@/components/SiteHeader.vue'
import SiteFooter from '@/components/SiteFooter.vue'
import OneClickPublishButton from '@/components/OneClickPublishButton.vue'
import OneClickPublishModal from '@/components/OneClickPublishModal.vue'
import PaymentMethodModal from '@/components/PaymentMethodModal.vue'
import OrderStatusMonitor from '@/components/OrderStatusMonitor.vue'
import RelatedProducts from '@/components/RelatedProducts.vue'
import ProductDetailTabs from '@/components/ProductDetailTabs.vue'
import InquiryFileUpload from '@/components/InquiryFileUpload.vue'
import encryptionService from '../data/encryption-service.js'
import apiSignature from '../services/apiSignature.js'
import { fetchWithSignature } from '../services/tokenRefresh.js'  // æ–°å¢ï¼šå¯¼å…¥å¸¦ç­¾åçš„ fetch å°è£…

// é¡µé¢ç¿»è¯‘æ•°æ®
const translations = ref({})

// å½“å‰è¯­è¨€ - ä» localStorage è¯»å–åˆå§‹å€¼
const currentLang = ref(localStorage.getItem('app.lang') || 'zh-CN')

// åŠ è½½ç¿»è¯‘æ–‡ä»¶
const loadTranslations = async () => {
  try {
    const response = await fetch('/frondend/lang/ItemDetailPage.json')
    const data = await response.json()
    translations.value = data
  } catch (error) {
    console.error('Failed to load translations:', error)
  }
}

// ç¿»è¯‘å‡½æ•° - ç›´æ¥ä»é¡µé¢ç‰¹å®šçš„JSONæ–‡ä»¶è¯»å–
const t = (key) => {
  // ä½¿ç”¨ currentLang.value ç¡®ä¿å“åº”å¼
  const lang = currentLang.value
  
  // ä»é¡µé¢ç‰¹å®šçš„ç¿»è¯‘æ–‡ä»¶ä¸­è·å–ç¿»è¯‘
  if (translations.value[lang] && translations.value[lang][key]) {
    return translations.value[lang][key]
  }
  
  // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ç¿»è¯‘ï¼Œè¿”å›é”®å
  return key
}

// æ›´æ–°é¡µé¢æ ‡é¢˜
const updatePageTitle = () => {
  const title = t('pageTitle')
  if (title && title !== 'pageTitle') {
    document.title = title
  }
}

// ç›‘å¬è¯­è¨€å˜åŒ–äº‹ä»¶
const handleLangChange = (event) => {
  if (event.detail && event.detail.lang) {
    currentLang.value = event.detail.lang
  }
  // é‡æ–°åŠ è½½ç¿»è¯‘ä»¥ç¡®ä¿è¯­è¨€åˆ‡æ¢æ—¶æ›´æ–°
  loadTranslations().then(() => {
    // ç¿»è¯‘åŠ è½½å®Œæˆåè®¾ç½®æ ‡é¢˜
    updatePageTitle()
  })
}

// ä» Symfony æ¥æ”¶ props
const props = defineProps({
  id: {
    type: [String, Number],
    default: ''
  }
})

const productId = computed(() => {
  // ä¼˜å…ˆä½¿ç”¨ä» Symfony ä¼ é€’çš„ id
  if (props.id) return String(props.id).replace(/\.html$/i, '')
  
  // å¤‡ç”¨æ–¹æ¡ˆï¼šä» URL è·¯å¾„ä¸­æå–
  const pathMatch = window.location.pathname.match(/\/item\/([^/?]+)/)
  return pathMatch ? pathMatch[1].replace(/\.html$/i, '') : ''
})

const product = ref(undefined)
const plinfo = ref(undefined)
const selectedImage = ref('')
const selectedIndex = ref(0)
const thumbnailOffset = ref(0)
const quantity = ref(1)

// ç½‘ç«™è´§å¸ç¬¦å·ï¼ˆä»SiteConfigè¯»å–ï¼‰
const siteCurrency = ref('USD')

const activeTab = ref('dropship')
const isPublishModalOpen = ref(false)
const isPaymentModalOpen = ref(false)
const showOrderMonitor = ref(false)
const processingOrderNo = ref('')
const selectedRegion = ref('') // å½“å‰é€‰ä¸­çš„å‘è´§åŒºåŸŸ
const selectedShippingMethod = ref('STANDARD_SHIPPING') // å½“å‰é€‰ä¸­çš„ç‰©æµæ–¹å¼ï¼Œé»˜è®¤æ ‡å‡†ç‰©æµ
const quantityError = ref('') // æ•°é‡è¾“å…¥é”™è¯¯æç¤º
const isAddingToCart = ref(false) // åŠ å…¥è´­ç‰©è½¦åŠ è½½çŠ¶æ€
const isDownloading = ref(false) // ä¸‹è½½å•†å“æ•°æ®åŠ è½½çŠ¶æ€

// å·¥å‚ç›´é‡‡è¯¢ä»·è¡¨å•æ•°æ®
const inquiryForm = ref({
  contactName: '',
  contactPhone: '',
  inquiryQuantity: 1,
  requirementDescription: '',
  attachments: []
})

const inquiryFormRef = ref(null)
const isSubmittingInquiry = ref(false)
const fileUploadKey = ref(0) // ç”¨äºå¼ºåˆ¶é‡ç½®é™„ä»¶ä¸Šä¼ ç»„ä»¶

// ä» window å¯¹è±¡è·å– store å®ä¾‹
const store = window.vueStore

// è·å–ç”¨æˆ·çŠ¶æ€
const user = computed(() => store?.state?.user || null)
const isLoggedIn = computed(() => store?.state?.isLoggedIn || false)

// è·å–å½“å‰ç”¨æˆ·çš„VIPç­‰çº§
const userVipLevel = computed(() => {
  if (isLoggedIn.value && user.value) {
    return user.value.vipLevel || 0
  }
  return 0
})

// è·å–å½“å‰ç”¨æˆ·çš„VIPç­‰çº§åç§°
const userVipLevelName = computed(() => {
  if (isLoggedIn.value && user.value) {
    // æ ¹æ®è¯­è¨€è¿”å›å¯¹åº”çš„VIPç­‰çº§åç§°ï¼ˆä½¿ç”¨ currentLang.value ç¡®ä¿å“åº”å¼ï¼‰
    const lang = currentLang.value
    if (lang === 'en') {
      // è‹±æ–‡ï¼šä¼˜å…ˆä½¿ç”¨ vipLevelNameEnï¼Œå¦‚æœæ²¡æœ‰åˆ™è¿”å› 'Normal User'
      return user.value.vipLevelNameEn || 'Normal User'
    }
    // ä¸­æ–‡ï¼šä½¿ç”¨ vipLevelNameï¼Œå¦‚æœæ²¡æœ‰åˆ™è¿”å› 'æ™®é€šç”¨æˆ·'
    return user.value.vipLevelName || 'æ™®é€šç”¨æˆ·'
  }
  // æœªç™»å½•æ—¶æ ¹æ®è¯­è¨€è¿”å›å¯¹åº”æ–‡æœ¬
  const lang = currentLang.value
  if (lang === 'en') {
    return translations.value['en']?.normalUser || 'Normal User'
  }
  return translations.value['zh-CN']?.normalUser || 'æ™®é€šç”¨æˆ·'
})

// è·å–å½“å‰åŒºåŸŸå½“å‰ç”¨æˆ·VIPç­‰çº§çš„ä¼šå‘˜æŠ˜æ‰£ä¿¡æ¯
const currentVipPriceInfo = computed(() => {
  const currentRegionData = getCurrentRegionData.value
  const vipLevel = userVipLevel.value
  
  console.log('=== VIPä»·æ ¼ä¿¡æ¯è°ƒè¯• ===')
  console.log('å½“å‰åŒºåŸŸæ•°æ®:', currentRegionData)
  console.log('ä»·æ ¼å¯¹è±¡:', currentRegionData?.price)
  console.log('ç”¨æˆ·VIPç­‰çº§:', vipLevel)
  
  if (!currentRegionData || !currentRegionData.price || !currentRegionData.price.vipPrices) {
    console.log('æ²¡æœ‰VIPä»·æ ¼æ•°æ® - priceå¯¹è±¡keys:', currentRegionData?.price ? Object.keys(currentRegionData.price) : 'null')
    return null
  }
  
  // ä»vipPricesæ•°ç»„ä¸­æŸ¥æ‰¾å¯¹åº”ç­‰çº§çš„ä»·æ ¼ä¿¡æ¯
  const vipPrices = currentRegionData.price.vipPrices
  console.log('VIPä»·æ ¼æ•°ç»„:', vipPrices)
  const vipPriceData = vipPrices.find(vp => vp.vipLevel === vipLevel)
  console.log('å½“å‰ç­‰çº§VIPä»·æ ¼:', vipPriceData)
  
  return vipPriceData || null
})

// è®¡ç®—ä¼šå‘˜æŠ˜æ‰£ä»·ï¼ˆä»åç«¯è¿”å›çš„vipPricesä¸­è·å–ï¼‰
const memberPrice = computed(() => {
  const vipInfo = currentVipPriceInfo.value
  
  console.log('=== ä¼šå‘˜ä»·æ ¼è®¡ç®— ===')
  console.log('VIPä¿¡æ¯:', vipInfo)
  
  if (vipInfo && vipInfo.price) {
    const price = parseFloat(vipInfo.price)
    console.log('ä¼šå‘˜ä»·æ ¼:', price)
    return price
  }
  
  console.log('æ— ä¼šå‘˜ä»·æ ¼')
  return 0
})

// åŸä»·ï¼ˆä»å½“å‰åŒºåŸŸé…ç½®ä¸­è·å–ï¼‰
const originalPrice = computed(() => {
  const currentRegionData = getCurrentRegionData.value
  if (currentRegionData && currentRegionData.price) {
    return parseFloat(currentRegionData.price.originalPrice) || 0
  }
  return 0
})

// æ˜¾ç¤ºçš„ä»·æ ¼ï¼šå¦‚æœç”¨æˆ·æœ‰ä¼šå‘˜æŠ˜æ‰£ï¼Œæ˜¾ç¤ºä¼šå‘˜ä»·æ ¼ï¼Œå¦åˆ™æ˜¾ç¤ºåŸºç¡€å”®ä»·
const displayPrice = computed(() => {
  if (memberPrice.value > 0) {
    return memberPrice.value
  }
  return basePrice.value
})

// æŠ˜æ‰£ç™¾åˆ†æ¯”æ–‡æœ¬ï¼šå¦‚æœæœ‰ä¼šå‘˜æŠ˜æ‰£ï¼Œæ˜¾ç¤ºä¾¿å®œçš„ç™¾åˆ†æ¯”ï¼ˆå¸¦å‡å·ï¼‰
const discountPercentText = computed(() => {
  const vipInfo = currentVipPriceInfo.value
  const selling = basePrice.value
  const memberPriceValue = memberPrice.value
  
  if (vipInfo && memberPriceValue > 0 && memberPriceValue < selling) {
    // è®¡ç®—ä¾¿å®œçš„ç™¾åˆ†æ¯”ï¼š(å”®ä»· - ä¼šå‘˜ä»·) / å”®ä»· * 100
    const savePercent = ((selling - memberPriceValue) / selling) * 100
    return `-${savePercent.toFixed(0)}%`
  }
  return ''
})

// æŠ˜æ‰£æ–‡æœ¬ï¼šå¦‚æœæœ‰ä¼šå‘˜æŠ˜æ‰£ï¼Œæ˜¾ç¤ºæŠ˜æ‰£ä¿¡æ¯
const discountText = computed(() => {
  const vipInfo = currentVipPriceInfo.value
  
  if (vipInfo && vipInfo.discount) {
    const discount = parseFloat(vipInfo.discount)
    return `${discount.toFixed(1)}${t('discount')}`
  }
  return t('noDiscount')
})

// åŸºç¡€ä»·æ ¼ï¼ˆåŸä»·ï¼‰
const basePrice = computed(() => {
  const currentRegionData = getCurrentRegionData.value
  if (currentRegionData && currentRegionData.price) {
    return parseFloat(currentRegionData.price.sellingPrice) || 0
  }
  return product.value?.basePrice || 0
})

const mainImageUrl = computed(() => {
  return (
    selectedImage.value ||
    (product.value?.images && product.value.images[selectedIndex.value]?.url) ||
    product.value?.mainImage ||
    ''
  )
})

// æ€»ä»·æ ¼æ˜¾ç¤ºï¼ˆä½¿ç”¨åç«¯è®¡ç®—çš„ä»·æ ¼ï¼Œè€Œä¸æ˜¯å‰ç«¯è®¡ç®—ï¼‰
const totalPrice = computed(() => {
  // å¦‚æœæœ‰æœ€æ–°è®¡ç®—çš„ä»·æ ¼ï¼Œä½¿ç”¨åç«¯è¿”å›çš„æ€»ä»·
  if (latestCalculatedPrice.value && latestCalculatedPrice.value.totalPrice) {
    // ã€åŸæœ‰æ˜¾ç¤ºé€»è¾‘ - å·²æ³¨é‡Šã€‘
    // åŸé€»è¾‘ï¼šä½¿ç”¨åç«¯è¿”å›çš„currencyå­—æ®µæˆ–currentCurrency
    // const currency = latestCalculatedPrice.value.currency || currentCurrency.value
    // return `${currency} ${latestCalculatedPrice.value.totalPrice}`
    
    // ã€æ–°é€»è¾‘ã€‘ä½¿ç”¨ä»SiteConfigè¯»å–çš„ç½‘ç«™è´§å¸ç¬¦å·
    return `${siteCurrency.value} ${latestCalculatedPrice.value.totalPrice}`
  }
  
  // å¦‚æœè¿˜æ²¡æœ‰åç«¯è®¡ç®—ç»“æœï¼ˆåˆå§‹åŠ è½½æ—¶ï¼‰ï¼Œæ˜¾ç¤ºé»˜è®¤ä»·æ ¼
  // ã€åŸæœ‰æ˜¾ç¤ºé€»è¾‘ - å·²æ³¨é‡Šã€‘
  // åŸé€»è¾‘ï¼šä½¿ç”¨currentCurrencyï¼ˆä»åŒºåŸŸé…ç½®è¯»å–ï¼‰
  // const currency = currentCurrency.value
  // const price = displayPrice.value * quantity.value
  // return `${currency} ${price.toFixed(2)}`
  
  // ã€æ–°é€»è¾‘ã€‘ä½¿ç”¨ä»SiteConfigè¯»å–çš„ç½‘ç«™è´§å¸ç¬¦å·
  const price = displayPrice.value * quantity.value
  return `${siteCurrency.value} ${price.toFixed(2)}`
})

// å•†å“æ ‡é¢˜æ˜¾ç¤ºï¼šä¼˜å…ˆè‹±æ–‡ï¼Œæ— è‹±æ–‡æ—¶æ˜¾ç¤ºä¸­æ–‡
const displayTitle = computed(() => {
  // ä½¿ç”¨ currentLang.value ç¡®ä¿å“åº”å¼æ›´æ–°
  const lang = currentLang.value
  // ä¸­æ–‡ç¯å¢ƒæ˜¾ç¤ºä¸­æ–‡æ ‡é¢˜
  if (lang === 'zh-CN') {
    return product.value?.title
  }
  // è‹±æ–‡ç¯å¢ƒä¼˜å…ˆæ˜¾ç¤ºè‹±æ–‡æ ‡é¢˜ï¼Œæ²¡æœ‰è‹±æ–‡æ ‡é¢˜åˆ™æ˜¾ç¤ºä¸­æ–‡æ ‡é¢˜
  return product.value?.titleEn || product.value?.title
})

// æ ¼å¼åŒ–æ»¡å‡åˆ¸æ˜¾ç¤ºæ–‡æœ¬
const couponText = computed(() => {
  const currentRegionData = getCurrentRegionData.value
  
  // å…ˆæ£€æŸ¥å½“å‰åŒºåŸŸæ˜¯å¦æœ‰æ»¡å‡
  if (currentRegionData && currentRegionData.discountRule) {
    const { currency, minAmount, discountAmount } = currentRegionData.discountRule
    const lang = currentLang.value
    if (lang === 'en') {
      return `${t('couponTextFull')}${currency}${parseFloat(minAmount).toFixed(2)}${t('couponTextMinus')}${currency}${parseFloat(discountAmount).toFixed(2)}`
    }
    return `${t('couponTextFull')}${currency}${parseFloat(minAmount).toFixed(2)}${t('couponTextMinus')}${currency}${parseFloat(discountAmount).toFixed(2)}`
  }
  
  // æ²¡æœ‰æ»¡å‡ï¼Œè¿”å›"æ— æ´»åŠ¨"
  return t('noActivity')
})

// ä»“åº“ç±»å‹æ˜¾ç¤ºæ–‡æœ¬
const warehouseTypeText = computed(() => {
  return t('warehouseTypeSY')
})

// å‘è´§åŒºåŸŸåˆ—è¡¨ï¼ˆä» JSON æ•°ç»„è·å–ï¼‰
const shippingRegions = computed(() => {
  if (!product.value?.shippingRegion || !Array.isArray(product.value.shippingRegion)) {
    return []
  }
  return product.value.shippingRegion.map((code, index) => ({
    code: code,
    label: code
  }))
})

// è·å–å½“å‰é€‰ä¸­åŒºåŸŸçš„æ•°æ®
const getCurrentRegionData = computed(() => {
  const region = selectedRegion.value
  if (!region || !product.value?.regionConfigs || !product.value.regionConfigs[region]) {
    return null
  }
  return product.value.regionConfigs[region]
})

// è·å–å½“å‰åŒºåŸŸçš„åº“å­˜
const currentStock = computed(() => {
  const currentRegionData = getCurrentRegionData.value
  if (currentRegionData) {
    return currentRegionData.stock || 0
  }
  return product.value?.stock || 0
})

// è·å–å½“å‰åŒºåŸŸçš„æœ€å°èµ·è®¢æ•°é‡ï¼ˆé»˜è®¤ä¸º1ï¼‰
const minOrderQuantity = computed(() => {
  const currentRegionData = getCurrentRegionData.value
  if (currentRegionData && currentRegionData.minOrderQty) {
    return parseInt(currentRegionData.minOrderQty) || 1
  }
  return 1
})

// è·å–å½“å‰åŒºåŸŸçš„è´§å¸ä¿¡æ¯
const currentCurrency = computed(() => {
  // ã€åŸæœ‰æ˜¾ç¤ºé€»è¾‘ - å·²æ³¨é‡Šã€‘
  // åŸé€»è¾‘ï¼šä»å•†å“æ•°æ®ä¸­è¯»å–å½“å‰åŒºåŸŸçš„è´§å¸ç¬¦å·
  // const currentRegionData = getCurrentRegionData.value
  // if (currentRegionData && currentRegionData.price) {
  //   return currentRegionData.price.currency || 'CNY'
  // }
  // return product.value?.currency || 'CNY'
  
  // ã€æ–°é€»è¾‘ã€‘ä½¿ç”¨ä»SiteConfigè¯»å–çš„ç½‘ç«™è´§å¸ç¬¦å·
  return siteCurrency.value
})

// è·å–å½“å‰åŒºåŸŸçš„è¿è´¹ï¼ˆæ ¹æ®é€‰æ‹©çš„ç‰©æµæ–¹å¼å’Œè´­ä¹°æ•°é‡ï¼‰
const currentShippingFee = computed(() => {
  // å¦‚æœé€‰æ‹©è‡ªæï¼Œè¿è´¹ä¸º0
  if (selectedShippingMethod.value === 'SELF_PICKUP') {
    return 0
  }
  
  // æ ‡å‡†ç‰©æµï¼Œä»å½“å‰åŒºåŸŸè·å–è¿è´¹
  const currentRegionData = getCurrentRegionData.value
  if (currentRegionData && currentRegionData.shipping) {
    const shippingPrice = parseFloat(currentRegionData.shipping.shippingPrice) || 0 // é¦–ä»¶è¿è´¹
    const additionalPrice = parseFloat(currentRegionData.shipping.additionalPrice) || 0 // ç»­ä»¶è¿è´¹
    const qty = quantity.value
    
    // å¦‚æœæ•°é‡ä¸º1ï¼Œåªæ”¶é¦–ä»¶è¿è´¹
    if (qty <= 1) {
      return shippingPrice
    }
    
    // å¦‚æœæ•°é‡å¤§äº1ï¼Œè®¡ç®—ï¼šé¦–ä»¶è¿è´¹ + ç»­ä»¶è¿è´¹ Ã— (æ•°é‡ - 1)
    const totalShipping = shippingPrice + (additionalPrice * (qty - 1))
    return totalShipping
  }
  return 0
})

// æ ¼å¼åŒ–è¿è´¹æ˜¾ç¤º
const formattedShippingFee = computed(() => {
  const fee = currentShippingFee.value
  const currency = currentCurrency.value
  const qty = quantity.value
  
  if (fee === 0) {
    return t('freeShipping')
  }
  
  const currentRegionData = getCurrentRegionData.value
  if (currentRegionData && currentRegionData.shipping) {
    const shippingPrice = parseFloat(currentRegionData.shipping.shippingPrice) || 0 // é¦–ä»¶è¿è´¹
    const additionalPrice = parseFloat(currentRegionData.shipping.additionalPrice) || 0 // ç»­ä»¶è¿è´¹
    
    // å¦‚æœæ²¡æœ‰ç»­ä»¶è¿è´¹ï¼Œåªæ˜¾ç¤ºæ€»è¿è´¹
    if (additionalPrice === 0) {
      return `${currency} ${fee.toFixed(2)}`
    }
    
    // å¦‚æœæ•°é‡ä¸º1ï¼Œåªæ˜¾ç¤ºé¦–ä»¶è¿è´¹
    if (qty === 1) {
      return `${currency} ${shippingPrice.toFixed(2)}`
    }
    
    // å¦‚æœæœ‰ç»­ä»¶è¿è´¹ä¸”æ•°é‡å¤§äº1ï¼Œæ˜¾ç¤ºè¯¦ç»†è®¡ç®—å…¬å¼
    return `${currency} ${shippingPrice.toFixed(2)} + ${currency} ${additionalPrice.toFixed(2)} Ã— ${qty - 1} = ${currency} ${fee.toFixed(2)}`
  }
  
  return `${currency} ${fee.toFixed(2)}`
})

// è·å–å½“å‰åŒºåŸŸçš„å‘è´§åœ°å€
const currentShippingAddress = computed(() => {
  const currentRegionData = getCurrentRegionData.value
  if (currentRegionData && currentRegionData.shippingAddress) {
    return currentRegionData.shippingAddress
  }
  return null
})

// è·å–å½“å‰åŒºåŸŸçš„é€€è´§åœ°å€
const currentReturnAddress = computed(() => {
  const currentRegionData = getCurrentRegionData.value
  if (currentRegionData && currentRegionData.returnAddress) {
    return currentRegionData.returnAddress
  }
  return null
})

// ä¼ é€’ç»™ ProductDetailTabs ç»„ä»¶çš„ product å¯¹è±¡ï¼ˆåŒ…å«å½“å‰åŒºåŸŸçš„åœ°å€ä¿¡æ¯ï¼‰
const productForTabs = computed(() => {
  if (!product.value) return null
  return {
    ...product.value,
    shippingAddress: currentShippingAddress.value,
    returnAddress: currentReturnAddress.value
  }
})

// é€‰æ‹©åŒºåŸŸ
function selectRegion(regionCode) {
  selectedRegion.value = regionCode
  
  // æ³¨æ„ï¼šè¿™é‡Œä¸å†è‡ªåŠ¨åˆ‡æ¢Tabï¼Œåªæ˜¯è®©dynamicBusinessTypeLabelè®¡ç®—å±æ€§è‡ªåŠ¨æ›´æ–°å³å¯
  // ç”¨æˆ·éœ€è¦æ‰‹åŠ¨ç‚¹å‡»Tabæ¥åˆ‡æ¢å†…å®¹
  
  // åˆ‡æ¢åŒºåŸŸæ—¶ï¼Œé‡ç½®æ•°é‡ä¸ºå½“å‰åŒºåŸŸçš„æœ€å°èµ·è®¢é‡
  quantity.value = minOrderQuantity.value
  quantityError.value = '' // æ¸…é™¤é”™è¯¯æç¤º
}

// é¢åŒ…å±‘åˆ†ç±»ä¿¡æ¯ï¼ˆæ ¹æ®è¯­è¨€åŠ¨æ€æ˜¾ç¤ºï¼‰
const breadcrumbCategory1 = computed(() => {
  if (!product.value?.category1) return null
  const lang = currentLang.value
  return {
    ...product.value.category1,
    displayName: lang === 'en' ? (product.value.category1.nameEn || product.value.category1.name) : product.value.category1.name
  }
})

const breadcrumbCategory2 = computed(() => {
  if (!product.value?.category2) return null
  const lang = currentLang.value
  return {
    ...product.value.category2,
    displayName: lang === 'en' ? (product.value.category2.nameEn || product.value.category2.name) : product.value.category2.name
  }
})

const breadcrumbCategory3 = computed(() => {
  if (!product.value?.category3) return null
  const lang = currentLang.value
  return {
    ...product.value.category3,
    displayName: lang === 'en' ? (product.value.category3.nameEn || product.value.category3.name) : product.value.category3.name
  }
})

// ç›¸å…³å•†å“æ¨è
const relatedProducts = computed(() => {
  return product.value?.relatedProducts || []
})

// åŠ¨æ€ä¸šåŠ¡ç±»å‹æ ‡ç­¾æ–‡æœ¬ï¼šæ ¹æ®å½“å‰åŒºåŸŸçš„ä¸šåŠ¡ç±»å‹æ˜¾ç¤º
const dynamicBusinessTypeLabel = computed(() => {
  const currentRegionData = getCurrentRegionData.value
  if (currentRegionData && currentRegionData.price && currentRegionData.price.businessType) {
    const businessType = currentRegionData.price.businessType
    // å¦‚æœæ˜¯wholesaleï¼ˆæ‰¹å‘ï¼‰ï¼Œæ˜¾ç¤º"æ‰¹å‘"ï¼›å¦åˆ™æ˜¾ç¤º"ä¸€ä»¶ä»£å‘"
    return businessType === 'wholesale' ? t('wholesaleBusiness') : t('dropshipping')
  }
  // é»˜è®¤æ˜¾ç¤º"ä¸€ä»¶ä»£å‘"
  return t('dropshipping')
})


async function loadProduct(id) {
  if (!id) {
    product.value = undefined
    plinfo.value = undefined
    selectedImage.value = ''
    selectedRegion.value = ''
    return
  }

  try {
    // è°ƒç”¨çœŸå®åç«¯APIï¼Œå¸¦ä¸Šè¯­è¨€å‚æ•°
    const lang = localStorage.getItem('app.lang') || currentLang.value
    const response = await fetch(`/shop/api/item-detail/product/${id}`, {
      headers: {
        'Accept-Language': lang
      }
    })
    const result = await response.json()
    
    if (result.success && result.product) {
      product.value = result.product
      plinfo.value = result.plinfo || {}
      
      // ä¿å­˜ç½‘ç«™è´§å¸ç¬¦å·
      if (result.siteCurrency) {
        siteCurrency.value = result.siteCurrency
      }
      
      // é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ªå‘è´§åŒºåŸŸ
      if (result.product.shippingRegion && result.product.shippingRegion.length > 0) {
        selectedRegion.value = result.product.shippingRegion[0]
        
        // è®¾ç½®æ•°é‡ä¸ºè¯¥åŒºåŸŸçš„æœ€å°èµ·è®¢é‡
        const firstRegion = result.product.shippingRegion[0]
        const regionConfig = result.product.regionConfigs?.[firstRegion]
        if (regionConfig && regionConfig.minOrderQty) {
          quantity.value = parseInt(regionConfig.minOrderQty) || 1
        } else {
          quantity.value = 1
        }
      }
      
      selectedIndex.value = 0
      selectedImage.value = result.product.mainImage || (result.product.images && result.product.images[0] && result.product.images[0].url) || ''
    } else {
      // æ ¹æ®è¯­è¨€æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
      const errorMsg = lang === 'en' ? (result.messageEn || result.message) : result.message
      console.error('Failed to load product:', errorMsg || 'Unknown error')
      
      // æ˜¾ç¤ºé”™è¯¯æç¤º
      ElMessage.error(errorMsg || (lang === 'en' ? 'Failed to load product' : 'åŠ è½½å•†å“å¤±è´¥'))
      
      product.value = undefined
      plinfo.value = undefined
      selectedRegion.value = ''
    }
  } catch (error) {
    console.error('Error loading product:', error)
    
    // æ˜¾ç¤ºç½‘ç»œé”™è¯¯æç¤º
    const lang = localStorage.getItem('app.lang') || currentLang.value
    ElMessage.error(lang === 'en' ? 'Network error, please try again' : 'ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•')
    
    product.value = undefined
    plinfo.value = undefined
    selectedRegion.value = ''
  }
}

onMounted(() => {
  // åˆå§‹åŠ è½½ç¿»è¯‘
  loadTranslations().then(() => {
    // ç¿»è¯‘åŠ è½½å®Œæˆåè®¾ç½®æ ‡é¢˜
    updatePageTitle()
  })
  loadProduct(productId.value)
  
  // ç›‘å¬è¯­è¨€å˜åŒ–äº‹ä»¶
  window.addEventListener('languagechange', handleLangChange)
})

onBeforeUnmount(() => {
  window.removeEventListener('languagechange', handleLangChange)
})

watch(() => productId.value, (newId) => {
  loadProduct(newId)
})

// ç›‘å¬æœ€å°èµ·è®¢é‡å˜åŒ–ï¼Œç¡®ä¿å½“å‰æ•°é‡ä¸å°äºæœ€å°èµ·è®¢é‡
watch(minOrderQuantity, (newMinQty) => {
  if (quantity.value < newMinQty) {
    quantity.value = newMinQty
  }
  quantityError.value = '' // æ¸…é™¤é”™è¯¯æç¤º
})

// ç›‘å¬æ•°é‡å˜åŒ–ï¼Œæ¸…é™¤é”™è¯¯æç¤ºå¹¶é‡æ–°è®¡ç®—ä»·æ ¼
watch(quantity, (newQty) => {
  if (newQty >= minOrderQuantity.value) {
    quantityError.value = ''
  }
  // â— æ•°é‡å˜åŒ–æ—¶ï¼Œé‡æ–°è°ƒç”¨åç«¯æ¥å£è®¡ç®—ä»·æ ¼
  debouncedFetchPrice()
})

// ç›‘å¬åŒºåŸŸå˜åŒ–ï¼Œé‡æ–°è®¡ç®—ä»·æ ¼
watch(selectedRegion, () => {
  // åŒºåŸŸå˜åŒ–æ—¶ç«‹å³è®¡ç®—ä»·æ ¼
  debouncedFetchPrice()
})

// ç›‘å¬ç‰©æµæ–¹å¼å˜åŒ–ï¼Œé‡æ–°è®¡ç®—ä»·æ ¼
watch(selectedShippingMethod, () => {
  // ç‰©æµæ–¹å¼å˜åŒ–æ—¶ç«‹å³è®¡ç®—ä»·æ ¼
  debouncedFetchPrice()
})

// é˜²æŠ–åŠ¨çš„ä»·æ ¼è®¡ç®—å‡½æ•°ï¼ˆé¿å…é¢‘ç¹è°ƒç”¨åç«¯æ¥å£ï¼‰
let fetchPriceTimeout = null
const debouncedFetchPrice = () => {
  if (fetchPriceTimeout) {
    clearTimeout(fetchPriceTimeout)
  }
  fetchPriceTimeout = setTimeout(() => {
    // åªæœ‰å½“å•†å“ã€åŒºåŸŸã€æ•°é‡éƒ½å­˜åœ¨æ—¶æ‰è°ƒç”¨
    if (product.value && selectedRegion.value && quantity.value > 0) {
      fetchPriceBreakdown()
    }
  }, 500) // 500ms é˜²æŠ–
}

function selectThumbnail(url, index) {
  selectedImage.value = url
  if (typeof index === 'number') selectedIndex.value = index
}

function handleThumbnailMouseMove(e) {
  const wrapper = e.currentTarget
  const scrollContainer = wrapper.querySelector('.thumbnail-scroll-container')
  if (!scrollContainer || !product.value?.images) return

  const items = wrapper.querySelectorAll('.thumbnail-item')
  const wrapperRect = wrapper.getBoundingClientRect()
  const scrollLeft = scrollContainer.style.transform
    ? parseInt(scrollContainer.style.transform.match(/\d+/)?.[0] || '0')
    : 0

  items.forEach((item, index) => {
    const itemRect = item.getBoundingClientRect()
    const itemLeft = itemRect.left - wrapperRect.left + scrollLeft
    const itemRight = itemLeft + itemRect.width

    const mouseX = e.clientX - wrapperRect.left
    if (mouseX >= itemLeft && mouseX <= itemRight) {
      if (product.value?.images && index >= 0 && index < product.value.images.length) {
        selectThumbnail(product.value.images[index].url, index)
      }
    }
  })
}

function scrollThumbnails(direction) {
  if (!product.value?.images) return

  const itemCount = product.value.images.length
  const itemsPerPage = 5
  const maxPages = Math.ceil(itemCount / itemsPerPage)
  let currentPage = Math.floor(thumbnailOffset.value / itemsPerPage)

  if (direction === 'prev') {
    currentPage = Math.max(0, currentPage - 1)
  } else {
    currentPage = Math.min(maxPages - 1, currentPage + 1)
  }

  thumbnailOffset.value = currentPage * itemsPerPage
}

function decreaseQty() {
  const minQty = minOrderQuantity.value
  if (quantity.value > minQty) {
    quantity.value -= 1
    quantityError.value = '' // æ¸…é™¤é”™è¯¯æç¤º
  }
}

function increaseQty() {
  quantity.value += 1
  quantityError.value = '' // æ¸…é™¤é”™è¯¯æç¤º
}

function handlePublish(platform) {
  if (!product.value) return
  console.log(`Publishing to ${platform}:`, product.value.sku)
  // è¿™é‡Œå¯ä»¥æ·»åŠ å®é™…çš„å‘å¸ƒé€»è¾‘
}

// ä»·æ ¼æ˜ç»†ï¼ˆä»åç«¯è·å–ï¼Œç”¨äºå¼¹çª—æ˜¾ç¤ºï¼‰
const priceBreakdown = ref([])
const isLoadingPriceBreakdown = ref(false)
// ä¿å­˜æœ€æ–°è®¡ç®—çš„ä»·æ ¼ï¼ˆåŒ…æ‹¬ totalPriceã€displayPriceã€subtotal ç­‰ï¼‰
const latestCalculatedPrice = ref(null)

// ä»åç«¯è·å–ä»·æ ¼æ˜ç»†
const fetchPriceBreakdown = async () => {
  console.log('ğŸ“Š === fetchPriceBreakdown å¼€å§‹æ‰§è¡Œ ===')
  console.log('ğŸ“Š å•†å“ä¿¡æ¯:', product.value)
  console.log('ğŸ“Š é€‰ä¸­åŒºåŸŸ:', selectedRegion.value)
  console.log('ğŸ“Š è´­ä¹°æ•°é‡:', quantity.value)
  
  if (!product.value || !selectedRegion.value || !quantity.value) {
    console.log('âŒ å‚æ•°ä¸å®Œæ•´:', { 
      hasProduct: !!product.value, 
      hasRegion: !!selectedRegion.value, 
      hasQuantity: !!quantity.value 
    })
    priceBreakdown.value = []
    return false
  }
  
  // è·å–å½“å‰åŒºåŸŸçš„ä¸šåŠ¡ç±»å‹
  const currentRegionData = getCurrentRegionData.value
  console.log('ğŸ“Š å½“å‰åŒºåŸŸæ•°æ®:', currentRegionData)
  const businessType = currentRegionData?.price?.businessType || 'dropship'
  console.log('ğŸ“Š ä¸šåŠ¡ç±»å‹:', businessType)
  
  isLoadingPriceBreakdown.value = true
  
  try {
    // å‡†å¤‡è¯·æ±‚æ•°æ®
    const requestData = {
      productId: product.value.id,
      region: selectedRegion.value,
      quantity: quantity.value,
      businessType: businessType,
      shippingMethod: selectedShippingMethod.value  // ä¼ é€’ç‰©æµæ–¹å¼
    }
    console.log('ğŸ“Š è¯·æ±‚åŸå§‹æ•°æ®:', requestData)
    
    // ä½¿ç”¨åŠ å¯†æœåŠ¡åŠ å¯†æ•´ä¸ªJSONå¯¹è±¡
    const encryptedData = encryptionService.prepareData(requestData, true)
    console.log('ğŸ“Š åŠ å¯†åæ•°æ®:', encryptedData)
    
    // ç”ŸæˆAPIç­¾å
    const signedData = apiSignature.sign(encryptedData)
    console.log('ğŸ“Š ç­¾ååæ•°æ®:', signedData)
    
    // è°ƒç”¨åç«¯API
    console.log('ğŸ“Š å¼€å§‹è°ƒç”¨ /shop/api/item-detail/calculate-price')
    const response = await fetch('/shop/api/item-detail/calculate-price', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Requested-With': 'XMLHttpRequest'
      },
      credentials: 'include',
      body: JSON.stringify(signedData)
    })
    
    console.log('ğŸ“Š å“åº”çŠ¶æ€:', response.status, response.statusText)
    const result = await response.json()
    console.log('ğŸ“Š åç«¯è¿”å›åŸå§‹ç»“æœ:', result)
    
    if (result.success && result.data) {
      // ä½¿ç”¨åç«¯è¿”å›çš„ä»·æ ¼æ˜ç»†ï¼Œå¹¶å¤„ç†æ•°æ®æ ¼å¼
      const breakdown = result.data.breakdown || []
      
      // è¯¦ç»†è°ƒè¯•ï¼šæ‰“å°åŸå§‹æ•°æ®
      console.log('ğŸ“¦ åç«¯è¿”å›åŸå§‹æ•°æ®:', {
        breakdown_raw: breakdown,
        breakdown_length: breakdown.length,
        totalPrice: result.data.totalPrice,
        displayPrice: result.data.displayPrice,
        subtotal: result.data.subtotal,
        currency: result.data.currency
      })
      
      // å¤„ç† amount å­—æ®µï¼šå°†å­—ç¬¦ä¸²è½¬ä¸ºæ•°å­—
      priceBreakdown.value = breakdown.map(item => {
        const processedItem = {
          ...item,
          amount: parseFloat(item.amount) || 0
        }
        console.log('ğŸ”„ å¤„ç†æ˜ç»†é¡¹:', {
          åŸå§‹: item,
          å¤„ç†å: processedItem
        })
        return processedItem
      })
      
      // â— ä¿å­˜æœ€æ–°è®¡ç®—çš„ä»·æ ¼ï¼ˆéå¸¸é‡è¦ï¼ç”¨äºåç»­æäº¤è®¢å•æ—¶éªŒè¯ä»·æ ¼ï¼‰
      latestCalculatedPrice.value = {
        totalPrice: result.data.totalPrice,
        displayPrice: result.data.displayPrice,
        subtotal: result.data.subtotal,
        currency: result.data.currency
      }
      
      // è°ƒè¯•ï¼šæ‰“å°ä»·æ ¼æ˜ç»†æ•°æ®
      console.log('âœ… ä»·æ ¼æ˜ç»†è·å–æˆåŠŸ:', {
        breakdown: priceBreakdown.value,
        breakdown_count: priceBreakdown.value.length,
        totalPrice: result.data.totalPrice,
        currency: result.data.currency,
        latestCalculatedPrice: latestCalculatedPrice.value
      })
      return true
    } else {
      priceBreakdown.value = []
      latestCalculatedPrice.value = null
      console.error('âŒ è·å–ä»·æ ¼æ˜ç»†å¤±è´¥:', result.message)
      console.error('âŒ è¯¦ç»†é”™è¯¯ä¿¡æ¯:', result)
      return false
    }
  } catch (error) {
    console.error('âŒ è·å–ä»·æ ¼æ˜ç»†å¼‚å¸¸:', error)
    console.error('âŒ å¼‚å¸¸å †æ ˆ:', error.stack)
    priceBreakdown.value = []
    return false
  } finally {
    isLoadingPriceBreakdown.value = false
    console.log('ğŸ“Š === fetchPriceBreakdown æ‰§è¡Œç»“æŸ ===')
  }
}

const isCheckingAddress = ref(false) // æ£€æŸ¥åœ°å€åŠ è½½çŠ¶æ€

async function openPaymentModal() {
  console.log('ğŸ” === openPaymentModal å¼€å§‹æ‰§è¡Œ ===')
  console.log('ğŸ” å½“å‰å•†å“ä¿¡æ¯:', product.value)
  console.log('ğŸ” é€‰ä¸­åŒºåŸŸ:', selectedRegion.value)
  console.log('ğŸ” è´­ä¹°æ•°é‡:', quantity.value)
  console.log('ğŸ” ç‰©æµæ–¹å¼:', selectedShippingMethod.value)
  console.log('ğŸ” æœ€å°èµ·è®¢é‡:', minOrderQuantity.value)
  
  if (!product.value) {
    console.log('âŒ product.value ä¸ºç©º')
    return
  }
  
  // 1. ä¼˜å…ˆæ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•
  console.log('ğŸ” æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€:', { isLoggedIn: isLoggedIn.value, user: user.value })
  if (!isLoggedIn.value || !user.value?.id) {
    console.log('âŒ ç”¨æˆ·æœªç™»å½•')
    const lang = currentLang.value
    const title = lang === 'en' ? 'Login Required' : 'è¯·å…ˆç™»å½•'
    const message = lang === 'en' 
      ? 'Please log in to continue your purchase' 
      : 'è¯·å…ˆç™»å½•åå†è¿›è¡Œè´­ä¹°'
    const confirmText = lang === 'en' ? 'Go to Login' : 'å»ç™»å½•'
    const cancelText = lang === 'en' ? 'Cancel' : 'å–æ¶ˆ'
    
    ElMessageBox.confirm(message, title, {
      confirmButtonText: confirmText,
      cancelButtonText: cancelText,
      type: 'warning',
      closeOnClickModal: false  // éµå¾ªé¡¹ç›®è§„èŒƒï¼šç¦æ­¢ç‚¹å‡»å¤–éƒ¨åŒºåŸŸå…³é—­å¼¹çª—
    }).then(() => {
      // ç‚¹å‡»å»ç™»å½•ï¼Œè·³è½¬åˆ°ç™»å½•é¡µï¼Œå¹¶æºå¸¦å½“å‰é¡µé¢ä½œä¸ºå›è·³åœ°å€
      const currentPath = window.location.pathname + window.location.search
      window.location.href = `/login?redirect=${encodeURIComponent(currentPath)}`
    }).catch(() => {
      // ç‚¹å‡»å–æ¶ˆï¼Œä¸åšä»»ä½•æ“ä½œ
    })
    return
  }
  
  // 2. éªŒè¯æ•°é‡æ˜¯å¦è¾¾åˆ°æœ€å°èµ·è®¢é‡
  console.log('ğŸ” éªŒè¯æ•°é‡:', { quantity: quantity.value, minOrderQuantity: minOrderQuantity.value })
  if (quantity.value < minOrderQuantity.value) {
    console.log('âŒ æ•°é‡æœªè¾¾åˆ°æœ€å°èµ·è®¢é‡')
    quantityError.value = `${t('minOrderQuantityIs')}${minOrderQuantity.value}`
    return
  }
  
  quantityError.value = ''
  
  // 3. æ£€æŸ¥ä¼šå‘˜æ˜¯å¦æœ‰æ”¶è´§åœ°å€
  console.log('ğŸ” å¼€å§‹æ£€æŸ¥æ”¶è´§åœ°å€...')
  isCheckingAddress.value = true
  
  try {
    // ä½¿ç”¨æ–°çš„ fetchWithSignature APIï¼ˆè‡ªåŠ¨å¤„ç†ç­¾ååˆ·æ–°ï¼‰
    const response = await fetchWithSignature(
      '/shop/api/customer/address/check',
      {},  // éœ€è¦ç­¾åçš„å‚æ•°ï¼ˆè¿™é‡Œä¸ºç©ºï¼‰
      { method: 'GET' }
    )
    
    const result = await response.json()
    console.log('ğŸ” åœ°å€æ£€æŸ¥ç»“æœ:', result)
    
    if (!result.success) {
      console.log('âŒ åœ°å€æ£€æŸ¥å¤±è´¥')
      const lang = currentLang.value
      const errorMsg = (lang === 'en' ? result.messageEn : result.message) || (lang === 'en' ? 'Failed to check address' : 'æ£€æŸ¥åœ°å€å¤±è´¥')
      ElMessage.error(errorMsg)
      isCheckingAddress.value = false
      return
    }
    
    // å¦‚æœæ²¡æœ‰åœ°å€ï¼Œä½¿ç”¨ ElMessage æç¤º
    if (!result.hasAddress) {
      console.log('âŒ ç”¨æˆ·æ²¡æœ‰æ”¶è´§åœ°å€')
      const lang = currentLang.value
      const message = lang === 'en' 
        ? 'You have not added a shipping address yet. Please add one before making a purchase.' 
        : 'æ‚¨è¿˜æ²¡æœ‰æ·»åŠ æ”¶è´§åœ°å€ï¼Œè¯·å…ˆæ·»åŠ åå†è¿›è¡Œè´­ä¹°ã€‚'
      
      isCheckingAddress.value = false
      ElMessage.warning(message)
      
      return
    }
    
    // 4. æœ‰åœ°å€ä¸”ç™»å½•ï¼Œè·å–ä»·æ ¼æ˜ç»†åæ‰“å¼€æ”¯ä»˜æ–¹å¼é€‰æ‹©å¼¹çª—
    console.log('âœ… åœ°å€æ£€æŸ¥é€šè¿‡')
    isCheckingAddress.value = false
    
    // â— é‡è¦ï¼šç‚¹å‡»ç«‹å³è´­ä¹°æ—¶ï¼Œå¼ºåˆ¶å–æ¶ˆé˜²æŠ–ï¼Œç«‹å³é‡æ–°è®¡ç®—æœ€æ–°ä»·æ ¼
    // å³ä½¿ç”¨æˆ·åˆšåˆšä¿®æ”¹äº†å‚æ•°ï¼Œä¹Ÿè¦ç¡®ä¿ä½¿ç”¨æœ€æ–°çš„æ•°é‡/åŒºåŸŸ/ç‰©æµæ–¹å¼é‡æ–°è®¡ç®—
    console.log('ğŸ“Š ç‚¹å‡»ç«‹å³è´­ä¹°ï¼Œå¼ºåˆ¶é‡æ–°è®¡ç®—æœ€æ–°ä»·æ ¼...')
    console.log('ğŸ“Š å½“å‰å‚æ•°:', {
      productId: product.value?.id,
      region: selectedRegion.value,
      quantity: quantity.value,
      shippingMethod: selectedShippingMethod.value
    })
    
    // å–æ¶ˆæ­£åœ¨è¿›è¡Œçš„é˜²æŠ–è®¡æ—¶å™¨ï¼ˆå¦‚æœæœ‰ï¼‰
    if (fetchPriceTimeout) {
      clearTimeout(fetchPriceTimeout)
      fetchPriceTimeout = null
      console.log('ğŸš« å·²å–æ¶ˆé˜²æŠ–è®¡æ—¶å™¨ï¼Œç«‹å³é‡æ–°è®¡ç®—ä»·æ ¼')
    }
    
    // ç«‹å³è°ƒç”¨åç«¯é‡æ–°è®¡ç®—ä»·æ ¼ï¼ˆä¸ç»è¿‡é˜²æŠ–ï¼‰
    const priceSuccess = await fetchPriceBreakdown()
    console.log('ğŸ“Š æœ€æ–°ä»·æ ¼è®¡ç®—ç»“æœ:', priceSuccess, priceBreakdown.value)
    console.log('ğŸ“Š æœ€æ–°æ€»ä»·:', latestCalculatedPrice.value)
    
    // åªæœ‰ä»·æ ¼è®¡ç®—æˆåŠŸæ‰æ‰“å¼€å¼¹çª—
    if (!priceSuccess) {
      console.log('âŒ ä»·æ ¼è®¡ç®—å¤±è´¥ï¼Œä¸æ‰“å¼€æ”¯ä»˜å¼¹çª—')
      return
    }
    
    // æ‰“å¼€å¼¹çª—
    console.log('âœ… æ‰“å¼€æ”¯ä»˜å¼¹çª—')
    isPaymentModalOpen.value = true
    
  } catch (error) {
    isCheckingAddress.value = false
    console.error('âŒ æ£€æŸ¥åœ°å€å¤±è´¥:', error)
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯è®¤è¯é”™è¯¯ï¼ˆ401æœªç™»å½•æˆ–ç­¾åå¤±æ•ˆï¼‰
    // æ³¨æ„ï¼šfetchWithSignature å·²ç»å¤„ç†äº† 401 å’Œ needRelogin çš„æƒ…å†µ
    // å¦‚æœè¿™é‡Œæ•è·åˆ°é”™è¯¯ï¼Œè¯´æ˜ Token åˆ·æ–°å·²å¤±è´¥ï¼Œéœ€è¦é‡æ–°ç™»å½•
    const { handleAuthError } = await import('../utils/authErrorHandler.js')
    
    // ç›´æ¥å¤„ç†ä¸ºè®¤è¯é”™è¯¯ï¼ˆå› ä¸º fetchWithSignature å·²ç»å°è¯•è¿‡åˆ·æ–°ï¼‰
    handleAuthError(store)
    return
  }
}

async function handlePaymentConfirm(data) {
  console.log('ğŸ”” === handlePaymentConfirm å¼€å§‹æ‰§è¡Œ ===')
  console.log('ğŸ”” ä¼ å…¥å‚æ•°:', data)
  console.log('ğŸ”” å½“å‰å•†å“:', product.value)
  
  if (!product.value) {
    console.log('âŒ product.value ä¸ºç©º')
    return
  }
  
  // å‰ç«¯éªŒè¯ï¼šæ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•ï¼ˆåŒé‡ä¿é™©ï¼Œç†è®ºä¸Š openPaymentModal å·²ç»æ£€æŸ¥è¿‡ï¼‰
  console.log('ğŸ”” æ£€æŸ¥ç™»å½•çŠ¶æ€:', { isLoggedIn: isLoggedIn.value, userId: user.value?.id })
  if (!isLoggedIn.value || !user.value?.id) {
    console.log('âŒ ç”¨æˆ·æœªç™»å½•')
    const lang = currentLang.value
    const message = lang === 'en' 
      ? 'Please log in to continue your purchase' 
      : 'è¯·å…ˆç™»å½•åå†è¿›è¡Œè´­ä¹°'
    ElMessage.warning(message)
    const currentPath = window.location.pathname + window.location.search
    window.location.href = `/login?redirect=${encodeURIComponent(currentPath)}`
    return
  }
  
  // è·å–åœ°å€ID
  const addressId = data.addressId
  console.log('ğŸ”” åœ°å€ID:', addressId)
  
  // å…³é—­æ”¯ä»˜æ–¹å¼å¼¹çª—
  isPaymentModalOpen.value = false
  
  // æ­¥éª¤1ï¼šç”Ÿæˆè®¢å•å·
  // ã€è®¢å•å·ç”Ÿæˆè§„åˆ™ã€‘æ ¼å¼ï¼šORD+å¹´æœˆæ—¥+å¾®ç§’æ—¶é—´æˆ³å6ä½+éšæœº2ä½åå…­è¿›åˆ¶
  // ç¤ºä¾‹ï¼šORD20250122456789A3ï¼ˆæ€»é•¿åº¦18ä½ï¼‰
  // è¯´æ˜ï¼šä¸åç«¯Orderå®ä½“çš„generateOrderNoæ–¹æ³•ä¿æŒä¸€è‡´
  const now = new Date()
  const dateStr = now.getFullYear().toString() + 
                  (now.getMonth() + 1).toString().padStart(2, '0') + 
                  now.getDate().toString().padStart(2, '0')
  const microPart = Date.now().toString().slice(-6)
  const randomPart = Math.random().toString(16).substr(2, 2).toUpperCase()
  const orderNo = `ORD${dateStr}${microPart}${randomPart}`
  console.log('ğŸ”” ç”Ÿæˆè®¢å•å·:', orderNo)
  
  // è·å–å½“å‰åŒºåŸŸçš„ä¸šåŠ¡ç±»å‹
  const currentRegionData = getCurrentRegionData.value
  console.log('ğŸ”” å½“å‰åŒºåŸŸæ•°æ®:', currentRegionData)
  let businessType = 'dropship' // é»˜è®¤ä¸€ä»¶ä»£å‘
  
  if (currentRegionData && currentRegionData.price && currentRegionData.price.businessType) {
    businessType = currentRegionData.price.businessType
  }
  console.log('ğŸ”” ä¸šåŠ¡ç±»å‹:', businessType)
  
  // â— é‡è¦ï¼šä½¿ç”¨åˆšåˆšè·å–çš„ä»·æ ¼æ˜ç»†ä¸­çš„æ€»ä»·ï¼Œè€Œä¸æ˜¯ totalPrice.valueï¼ˆå¯èƒ½æ˜¯è¿‡æœŸçš„ç¼“å­˜å€¼ï¼‰
  // latestCalculatedPrice æ˜¯åœ¨ fetchPriceBreakdown() æ—¶ä¿å­˜çš„æœ€æ–°åç«¯è®¡ç®—ç»“æœ
  let calculatedTotalPrice = 0
  if (latestCalculatedPrice.value && latestCalculatedPrice.value.totalPrice) {
    calculatedTotalPrice = parseFloat(latestCalculatedPrice.value.totalPrice)
    console.log('ğŸ“Š ä½¿ç”¨æœ€æ–°è®¡ç®—çš„æ€»ä»·:', calculatedTotalPrice)
  } else {
    // å¦‚æœæ²¡æœ‰æœ€æ–°ä»·æ ¼ï¼Œä½¿ç”¨ totalPrice.value ä½œä¸ºåå¤‡
    calculatedTotalPrice = parseFloat(totalPrice.value.replace(/[^0-9.]/g, ''))
    console.warn('âš ï¸ æ²¡æœ‰æœ€æ–°è®¡ç®—ä»·æ ¼ï¼Œä½¿ç”¨ totalPrice.value:', calculatedTotalPrice)
  }
  
  // æ­¥éª¤2ï¼šå‡†å¤‡è¯·æ±‚æ•°æ®ï¼ˆä¸ç«‹å³æäº¤ï¼‰
  // â— é‡è¦ï¼šæ”¯ä»˜æ–¹å¼ä¸ºç©ºï¼Œç­‰å¾…è®¢å•ç”ŸæˆæˆåŠŸåå†å¡«å†™
  const requestData = {
    orderNo: orderNo,
    productId: product.value.id,
    region: selectedRegion.value,
    quantity: quantity.value,
    paymentMethod: '', // æ”¯ä»˜æ–¹å¼ç•™ç©º
    shippingMethod: selectedShippingMethod.value,
    customerId: user.value.id,
    businessType: businessType, // æ·»åŠ ä¸šåŠ¡ç±»å‹å­—æ®µ
    totalPrice: calculatedTotalPrice, // ä½¿ç”¨æœ€æ–°è®¡ç®—çš„æ€»ä»·
    addressId: addressId // æ·»åŠ åœ°å€ID
  }
  console.log('ğŸ”” å‡†å¤‡çš„è¯·æ±‚æ•°æ®:', requestData)
  
  // ä¿å­˜å¾…æäº¤çš„è®¢å•æ•°æ®
  pendingOrderData.value = { orderNo, requestData }
  
  // æ­¥éª¤3ï¼šæ˜¾ç¤ºè®¢å•çŠ¶æ€ç›‘æ§å¼¹çª—ï¼ˆä¼šç«‹å³å»ºç«‹ Mercure è¿æ¥ï¼‰
  processingOrderNo.value = orderNo
  showOrderMonitor.value = true
  
  // æ­¥éª¤4ï¼šç­‰å¾… Mercure è¿æ¥å°±ç»ªåï¼ŒhandleMercureReady ä¼šè¢«è§¦å‘ï¼Œç„¶åæ‰æäº¤è®¢å•
  console.log('ğŸ”” ç­‰å¾… Mercure è¿æ¥å°±ç»ª...')
  console.log('ğŸ”” === handlePaymentConfirm æ‰§è¡Œç»“æŸ ===')
}

// å…³é—­è®¢å•ç›‘æ§å¼¹çª—
function handleOrderMonitorClose() {
  console.log('ğŸšª å…³é—­è®¢å•ç›‘æ§å¼¹çª—')
  showOrderMonitor.value = false
  
  // å»¶è¿Ÿæ¸…ç©ºæ‰€æœ‰çŠ¶æ€ï¼Œé¿å…å…³é—­åŠ¨ç”»æ—¶çœ‹åˆ°çŠ¶æ€å˜åŒ–
  setTimeout(() => {
    console.log('ğŸ§¹ æ¸…ç©ºè®¢å•ç›¸å…³çŠ¶æ€')
    processingOrderNo.value = ''
    pendingOrderData.value = null
    // OrderStatusMonitor ç»„ä»¶ä¼šåœ¨è‡ªå·±çš„ close() æ–¹æ³•ä¸­è°ƒç”¨ cleanupConnection()
  }, 300)
}

// Mercure è¿æ¥å°±ç»ªåçš„å›è°ƒ
const pendingOrderData = ref(null)

async function handleMercureReady() {
  console.log('ğŸ”Œ === handleMercureReady å¼€å§‹æ‰§è¡Œ ===')
  console.log('ğŸ”Œ Mercure è¿æ¥å·²å°±ç»ªï¼Œå¼€å§‹æäº¤è®¢å•')
  
  if (!pendingOrderData.value) {
    console.warn('âŒ æ²¡æœ‰å¾…æäº¤çš„è®¢å•æ•°æ®')
    return
  }
  
  const { orderNo, requestData } = pendingOrderData.value
  console.log('ğŸ”Œ è®¢å•å·:', orderNo)
  console.log('ğŸ”Œ åŸå§‹è¯·æ±‚æ•°æ®:', requestData)
  
  try {
    // ä½¿ç”¨åŠ å¯†æœåŠ¡åŠ å¯†æ•´ä¸ªJSONå¯¹è±¡
    console.log('ğŸ”Œ å¼€å§‹åŠ å¯†è¯·æ±‚æ•°æ®...')
    const encryptedData = encryptionService.prepareData(requestData, true)
    console.log('ğŸ”Œ åŠ å¯†åæ•°æ®:', encryptedData)
    
    // ç”ŸæˆAPIç­¾å
    console.log('ğŸ”Œ ç”ŸæˆAPIç­¾å...')
    const signedData = apiSignature.sign(encryptedData)
    console.log('ğŸ”Œ ç­¾ååæ•°æ®:', signedData)
    
    console.log('ğŸ”Œ å‘é€æ”¯ä»˜ç¡®è®¤è¯·æ±‚ï¼ˆåŠ å¯†+ç­¾åï¼‰:', signedData)
    
    // è°ƒç”¨åç«¯ API
    console.log('ğŸ”Œ å¼€å§‹è°ƒç”¨ /shop/api/item-detail/confirm-payment')
    const response = await fetch('/shop/api/item-detail/confirm-payment', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Requested-With': 'XMLHttpRequest'
      },
      credentials: 'include',
      body: JSON.stringify(signedData)
    })
    
    console.log('ğŸ”Œ å“åº”çŠ¶æ€:', response.status, response.statusText)
    const result = await response.json()
    console.log('ğŸ”Œ åç«¯è¿”å›ç»“æœ:', result)
    
    if (!result.success) {
      // è®¢å•åˆ›å»ºå¤±è´¥
      console.error('âŒ è®¢å•åˆ›å»ºå¤±è´¥:', result)
      showOrderMonitor.value = false
      processingOrderNo.value = ''
      pendingOrderData.value = null
      
      const lang = currentLang.value
      const errorMsg = (lang === 'en' ? result.messageEn : result.message) || (lang === 'en' ? 'Purchase failed, please try again' : 'è´­ä¹°å¤±è´¥ï¼Œè¯·é‡è¯•')
      ElMessage.error(errorMsg)
      console.error('âŒ è®¢å•åˆ›å»ºå¤±è´¥:', result)
    } else {
      console.log('âœ… è®¢å•åˆ›å»ºæˆåŠŸï¼Œç­‰å¾… Mercure æ¶ˆæ¯æ›´æ–°çŠ¶æ€')
    }
    // æˆåŠŸçš„è¯ï¼Œç­‰å¾… Mercure æ¶ˆæ¯æ›´æ–°çŠ¶æ€
    
    // æ¸…ç©ºå¾…æäº¤æ•°æ®
    pendingOrderData.value = null
    console.log('ğŸ”Œ === handleMercureReady æ‰§è¡Œç»“æŸ ===')
    
  } catch (error) {
    console.error('âŒ æ”¯ä»˜è¯·æ±‚å¼‚å¸¸:', error)
    console.error('âŒ å¼‚å¸¸å †æ ˆ:', error.stack)
    
    showOrderMonitor.value = false
    processingOrderNo.value = ''
    pendingOrderData.value = null
    
    const lang = currentLang.value
    ElMessage.error(lang === 'en' ? 'System error, please try again later' : 'ç³»ç»Ÿé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•')
  }
}

// é‡æ–°æ”¯ä»˜
function handleRetryPayment() {
  console.log('ğŸ”„ é‡æ–°æ”¯ä»˜')
  showOrderMonitor.value = false
  
  // ç«‹å³æ¸…ç©ºè®¢å•å·å’Œå¾…æäº¤æ•°æ®ï¼Œä¸ºä¸‹æ¬¡æ”¯ä»˜åšå‡†å¤‡
  setTimeout(() => {
    console.log('ğŸ§¹ æ¸…ç©ºè®¢å•çŠ¶æ€ï¼Œå‡†å¤‡é‡æ–°æ”¯ä»˜')
    processingOrderNo.value = ''
    pendingOrderData.value = null
    // é‡æ–°æ‰“å¼€æ”¯ä»˜æ–¹å¼é€‰æ‹©å¼¹çª—
    isPaymentModalOpen.value = true
  }, 300)
}

// æŸ¥çœ‹è®¢å•è¯¦æƒ…
function handleViewOrder(orderNo) {
  console.log('ğŸ“‹ æŸ¥çœ‹è®¢å•è¯¦æƒ…:', orderNo)
  showOrderMonitor.value = false
  
  // æ¸…ç©ºçŠ¶æ€åè·³è½¬
  setTimeout(() => {
    processingOrderNo.value = ''
    pendingOrderData.value = null
    // è·³è½¬åˆ°è®¢å•è¯¦æƒ…é¡µ
    window.location.href = `/customer/orders/${orderNo}`
  }, 100)
}

// ç»§ç»­è´­ç‰©
function handleContinueShopping() {
  console.log('ğŸ›ï¸ ç»§ç»­è´­ç‰©')
  showOrderMonitor.value = false
  
  // å»¶è¿Ÿæ¸…ç©ºè®¢å•å·ï¼Œä¸ºä¸‹æ¬¡æ”¯ä»˜åšå‡†å¤‡
  setTimeout(() => {
    console.log('ğŸ§¹ æ¸…ç©ºè®¢å•çŠ¶æ€')
    processingOrderNo.value = ''
    pendingOrderData.value = null
  }, 300)
  // å¯é€‰ï¼šè·³è½¬åˆ°é¦–é¡µæˆ–å•†å“åˆ—è¡¨é¡µ
  // window.location.href = '/'
}

// æ”¯ä»˜æˆåŠŸåçš„å¤„ç†
function handlePaymentSuccess() {
  console.log('ğŸ‰ æ”¯ä»˜æˆåŠŸ')
  
  // å…³é—­ç›‘æ§å¼¹çª—
  showOrderMonitor.value = false
  
  // æ¸…ç©ºçŠ¶æ€
  setTimeout(() => {
    processingOrderNo.value = ''
    pendingOrderData.value = null
  }, 300)
  
  // æ³¨æ„ï¼šä¸åœ¨è¿™é‡Œæ˜¾ç¤ºæˆåŠŸæç¤ºï¼Œå› ä¸º OrderStatusMonitor ç»„ä»¶å·²ç»æ˜¾ç¤ºäº†
}

// åŠ å…¥è´­ç‰©è½¦
async function handleAddToCart() {
  if (!product.value) return
  
  // éªŒè¯æ•°é‡æ˜¯å¦è¾¾åˆ°æœ€å°èµ·è®¢é‡
  if (quantity.value < minOrderQuantity.value) {
    quantityError.value = `${t('minOrderQuantityIs')}${minOrderQuantity.value}`
    return
  }
  
  // éªŒè¯ç”¨æˆ·æ˜¯å¦ç™»å½•
  if (!isLoggedIn.value || !user.value?.id) {
    const lang = currentLang.value
    const message = lang === 'en' ? 'Please log in first' : 'è¯·å…ˆç™»å½•'
    ElMessage.warning(message)
    const currentPath = window.location.pathname + window.location.search
    window.location.href = `/login?redirect=${encodeURIComponent(currentPath)}`
    return
  }
  
  // éªŒè¯æ˜¯å¦é€‰æ‹©äº†å‘è´§åŒºåŸŸ
  if (!selectedRegion.value) {
    const lang = currentLang.value
    const message = lang === 'en' ? 'Please select a shipping region' : 'è¯·é€‰æ‹©å‘è´§åŒºåŸŸ'
    ElMessage.warning(message)
    return
  }
  
  // é˜²æ­¢é‡å¤æäº¤
  if (isAddingToCart.value) return
  
  quantityError.value = ''
  isAddingToCart.value = true
  
  try {
    // è·å–å½“å‰åŒºåŸŸçš„ä¸šåŠ¡ç±»å‹ï¼ˆä»åç«¯è¿”å›çš„ regionData.price.businessType è·å–ï¼‰
    const currentRegionData = getCurrentRegionData.value
    let businessType = 'dropship' // é»˜è®¤ä¸€ä»¶ä»£å‘
    
    if (currentRegionData && currentRegionData.price && currentRegionData.price.businessType) {
      businessType = currentRegionData.price.businessType
    }
    
    const requestData = {
      productId: product.value.id,
      sku: product.value.sku,
      region: selectedRegion.value,
      quantity: quantity.value,
      businessType: businessType, // ä½¿ç”¨å½“å‰åŒºåŸŸçš„ä¸šåŠ¡ç±»å‹
      sellingPrice: displayPrice.value.toString(),
      originalPrice: originalPrice.value > 0 ? originalPrice.value.toString() : null,
      currency: currentCurrency.value,
      availableStock: currentStock.value
    }
    
    // ä½¿ç”¨åŠ å¯†æœåŠ¡åŠ å¯†æ•´ä¸ªJSONå¯¹è±¡ï¼ˆå’Œç«‹å³è´­ä¹°ä¿æŒä¸€è‡´ï¼‰
    const encryptedData = encryptionService.prepareData(requestData, true)
    
    // ç”ŸæˆAPIç­¾å
    const signedData = apiSignature.sign(encryptedData)
    
    const response = await fetch('/shop/api/cart/add', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      credentials: 'include',
      body: JSON.stringify(signedData)
    })
    
    const result = await response.json()
    
    if (result.success) {
      const lang = currentLang.value
      const message = lang === 'en' ? 'Added to cart successfully' : 'å·²æ·»åŠ åˆ°è´­ç‰©è½¦'
      ElMessage.success(message)
    } else {
      const lang = currentLang.value
      const errorMsg = (lang === 'en' ? result.messageEn : result.message) || (lang === 'en' ? 'Failed to add to cart' : 'åŠ å…¥è´­ç‰©è½¦å¤±è´¥')
      ElMessage.error(errorMsg)
      console.error('åŠ å…¥è´­ç‰©è½¦å¤±è´¥:', result)
    }
  } catch (error) {
    console.error('åŠ å…¥è´­ç‰©è½¦è¯·æ±‚å¤±è´¥:', error)
    
    const lang = currentLang.value
    ElMessage.error(lang === 'en' ? 'System error, please try again later' : 'ç³»ç»Ÿé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•')
  } finally {
    isAddingToCart.value = false
  }
}

// ä¸‹è½½å•†å“æ•°æ®
async function handleDownloadProduct() {
  if (isDownloading.value) return
  
  // éªŒè¯ç”¨æˆ·æ˜¯å¦ç™»å½•
  if (!isLoggedIn.value || !user.value?.id) {
    const lang = currentLang.value
    const title = lang === 'en' ? 'Login Required' : 'è¯·å…ˆç™»å½•'
    const message = lang === 'en' 
      ? 'Please log in to download product data' 
      : 'è¯·å…ˆç™»å½•åå†ä¸‹è½½å•†å“æ•°æ®'
    const confirmText = lang === 'en' ? 'Go to Login' : 'å»ç™»å½•'
    const cancelText = lang === 'en' ? 'Cancel' : 'å–æ¶ˆ'
    
    ElMessageBox.confirm(message, title, {
      confirmButtonText: confirmText,
      cancelButtonText: cancelText,
      type: 'warning',
      closeOnClickModal: false
    }).then(() => {
      const currentPath = window.location.pathname + window.location.search
      window.location.href = `/login?redirect=${encodeURIComponent(currentPath)}`
    }).catch(() => {})
    return
  }
  
  if (!product.value?.id) {
    const lang = currentLang.value
    ElMessage.error(lang === 'en' ? 'Product information not loaded' : 'å•†å“ä¿¡æ¯æœªåŠ è½½')
    return
  }
  
  isDownloading.value = true
  
  try {
    const requestData = {
      productId: product.value.id
    }
    
    const encryptedData = encryptionService.prepareData(requestData, true)
    const signedData = apiSignature.sign(encryptedData)
    
    const response = await fetch('/shop/api/download-center/download', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      credentials: 'include',
      body: JSON.stringify(signedData)
    })
    
    const result = await response.json()
    
    if (result.success) {
      const lang = currentLang.value
      const message = lang === 'en' 
        ? 'Download task created successfully! Please check the download center later to get the file.' 
        : 'ä¸‹è½½ä»»åŠ¡å·²åˆ›å»ºæˆåŠŸï¼è¯·ç¨ååˆ°ä¸‹è½½ä¸­å¿ƒæŸ¥çœ‹ç”Ÿæˆçš„æ–‡ä»¶ã€‚'
      
      ElMessage.success({
        message: message,
        duration: 5000,
        showClose: true
      })
    } else {
      const lang = currentLang.value
      const errorMsg = (lang === 'en' ? result.messageEn : result.message) 
        || (lang === 'en' ? 'Download failed' : 'ä¸‹è½½å¤±è´¥')
      ElMessage.error(errorMsg)
    }
  } catch (error) {
    console.error('ä¸‹è½½è¯·æ±‚å¤±è´¥:', error)
    const lang = currentLang.value
    ElMessage.error(lang === 'en' ? 'System error, please try again later' : 'ç³»ç»Ÿé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•')
  } finally {
    isDownloading.value = false
  }
}

// æäº¤å·¥å‚ç›´é‡‡è¯¢ä»·è¡¨å•
async function handleSubmitInquiry() {
  // éªŒè¯ç”¨æˆ·æ˜¯å¦ç™»å½•
  if (!isLoggedIn.value || !user.value?.id) {
    const lang = currentLang.value
    const title = lang === 'en' ? 'Login Required' : 'è¯·å…ˆç™»å½•'
    const message = lang === 'en' 
      ? 'Please log in to submit inquiry' 
      : 'è¯·å…ˆç™»å½•åå†æäº¤è¯¢ä»·'
    const confirmText = lang === 'en' ? 'Go to Login' : 'å»ç™»å½•'
    const cancelText = lang === 'en' ? 'Cancel' : 'å–æ¶ˆ'
    
    ElMessageBox.confirm(message, title, {
      confirmButtonText: confirmText,
      cancelButtonText: cancelText,
      type: 'warning',
      closeOnClickModal: false
    }).then(() => {
      const currentPath = window.location.pathname + window.location.search
      window.location.href = `/login?redirect=${encodeURIComponent(currentPath)}`
    }).catch(() => {})
    return
  }
  
  // éªŒè¯è¡¨å•
  if (!inquiryForm.value.contactName || !inquiryForm.value.contactPhone || !inquiryForm.value.inquiryQuantity || !inquiryForm.value.requirementDescription) {
    const lang = currentLang.value
    ElMessage.error(lang === 'en' ? 'Please fill in all required fields' : 'è¯·å¡«å†™æ‰€æœ‰å¿…å¡«é¡¹')
    return
  }
  
  // éªŒè¯æ‰‹æœºå·
  const phonePattern = /^1[3-9]\d{9}$/
  const intlPhonePattern = /^\+?[\d\s-]{8,20}$/
  if (!phonePattern.test(inquiryForm.value.contactPhone) && !intlPhonePattern.test(inquiryForm.value.contactPhone)) {
    const lang = currentLang.value
    ElMessage.error(lang === 'en' ? 'Please enter a valid phone number' : 'è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·')
    return
  }
  
  // éªŒè¯æ•°é‡
  if (inquiryForm.value.inquiryQuantity < 1) {
    const lang = currentLang.value
    ElMessage.error(lang === 'en' ? 'Quantity must be greater than 0' : 'æ•°é‡å¿…é¡»å¤§äº0')
    return
  }
  
  if (!product.value?.id) {
    const lang = currentLang.value
    ElMessage.error(lang === 'en' ? 'Product information not loaded' : 'å•†å“ä¿¡æ¯æœªåŠ è½½')
    return
  }
  
  isSubmittingInquiry.value = true
  
  try {
    const requestData = {
      productId: product.value.id,
      contactName: inquiryForm.value.contactName.trim(),
      contactPhone: inquiryForm.value.contactPhone.trim(),
      inquiryQuantity: inquiryForm.value.inquiryQuantity,
      requirementDescription: inquiryForm.value.requirementDescription.trim(),
      attachments: inquiryForm.value.attachments
    }
    
    const signedData = apiSignature.sign(requestData)
    
    const response = await fetch('/shop/api/inquiry/submit', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      credentials: 'include',
      body: JSON.stringify(signedData)
    })
    
    const result = await response.json()
    
    if (result.success) {
      const lang = currentLang.value
      const message = lang === 'en' ? result.messageEn : result.message
      
      ElMessage.success({
        message: message,
        duration: 5000,
        showClose: true
      })
      
      // æ¸…ç©ºè¡¨å•
      inquiryForm.value = {
        contactName: '',
        contactPhone: '',
        inquiryQuantity: 1,
        requirementDescription: '',
        attachments: []
      }
      
      // å¼ºåˆ¶é‡ç½®é™„ä»¶ä¸Šä¼ ç»„ä»¶ï¼Œæ¸…é™¤æ‰€æœ‰é™„ä»¶æ˜¾ç¤º
      fileUploadKey.value++
    } else {
      const lang = currentLang.value
      const errorMsg = (lang === 'en' ? result.messageEn : result.message) 
        || (lang === 'en' ? 'Submission failed' : 'æäº¤å¤±è´¥')
      ElMessage.error(errorMsg)
    }
  } catch (error) {
    console.error('æäº¤è¯¢ä»·å•å¤±è´¥:', error)
    const lang = currentLang.value
    ElMessage.error(lang === 'en' ? 'System error, please try again later' : 'ç³»ç»Ÿé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•')
  } finally {
    isSubmittingInquiry.value = false
  }
}
</script>

<template>
  <div class="min-h-screen flex flex-col page">
    <SiteHeader />

    <main class="flex-1">
      <!-- é¢åŒ…å±‘å¯¼èˆª -->
      <div class="breadcrumb-wrapper">
        <div class="breadcrumb-container">
          <a href="/" class="breadcrumb-link">{{ t('home') }}</a>
          <template v-if="breadcrumbCategory1">
            <ChevronRight :size="16" class="breadcrumb-arrow" />
            <a :href="`/all-categories-products?categoryId=${breadcrumbCategory1.id}`" class="breadcrumb-link">
              {{ breadcrumbCategory1.displayName }}
            </a>
          </template>
          <template v-if="breadcrumbCategory2">
            <ChevronRight :size="16" class="breadcrumb-arrow" />
            <a :href="`/all-categories-products?subcategoryId=${breadcrumbCategory2.id}`" class="breadcrumb-link">
              {{ breadcrumbCategory2.displayName }}
            </a>
          </template>
          <template v-if="breadcrumbCategory3">
            <ChevronRight :size="16" class="breadcrumb-arrow" />
            <a :href="`/all-categories-products?itemId=${breadcrumbCategory3.id}`" class="breadcrumb-link">
              {{ breadcrumbCategory3.displayName }}
            </a>
          </template>
        </div>
      </div>

      <div class="content-container">
        <!-- å·¦ä¾§ï¼šå•†å“å›¾ç‰‡åŒºåŸŸ -->
        <div class="product-section">
          <div class="image-gallery-wrapper">
            <!-- ä¸»å›¾ -->
            <div class="main-image-container">
              <img v-if="mainImageUrl" :src="mainImageUrl" width="500" height="500" :alt="displayTitle" loading="lazy" class="main-image" />
              <div v-else class="no-image-placeholder">{{ t('noImageAvailable') }}</div>
              <div class="image-overlay"></div>
            </div>

            <!-- ç¼©ç•¥å›¾å¯¼èˆª -->
            <div class="thumbnail-navigation">
              <div class="thumbnails-wrapper">
                <ul class="thumbnail-scroll-container">
                  <li v-for="(img, idx) in (product?.images || [])" :key="img.id || idx" class="thumbnail-item" @click="selectThumbnail(img.url, idx)">
                    <div class="thumbnail-image-wrapper" :class="{ active: (selectedImage ? selectedImage === img.url : selectedIndex === idx) }">
                      <img :alt="img.alt || displayTitle" loading="lazy" :src="img.url" class="thumbnail-image" />
                    </div>
                  </li>
                </ul>
              </div>
            </div>

            <!-- å¤§å›¾é¢„è§ˆ -->
            <div class="large-preview">
              <img v-if="mainImageUrl" :src="mainImageUrl" width="1000" height="1000" :alt="t('productLargeImage')" loading="lazy" class="large-preview-image" />
            </div>
          </div>
        </div>

        <!-- å³ä¾§ï¼šå•†å“ä¿¡æ¯åŒºåŸŸ -->
        <div class="product-details-section">
          <!-- å¹¿å‘Šæ¨ªå¹… -->
          <div class="warning-banner">
            <img loading="lazy" src="/images/icons/prohibition.svg" class="warning-icon" alt="ç¦æ­¢" />
            <p class="warning-text"></p>
          </div>

          <div class="product-info-wrapper">
            <!-- å•†å“æ ‡é¢˜ä¿¡æ¯ -->
            <div class="product-header">
              <h1 :title="displayTitle" class="product-title">
                <span class="title-text">{{ displayTitle }}</span>
              </h1>
              <p class="sku-info">SKUï¼š{{ product?.sku || '' }}</p>
              <span class="spu-info">SPUï¼š{{ product?.spu || '' }}</span>
              <span class="publish-date">{{ t('publishDate') }}{{ product?.publishDate || '' }}</span>
            </div>

            <!-- å•†å“æ ‡ç­¾/Tabèœå• -->
            <div class="product-tags">
              <ul class="tags-list">
                <li class="tag-dropship" :class="{ active: activeTab === 'dropship' }" @click="activeTab = 'dropship'">
                  {{ dynamicBusinessTypeLabel }}
                </li>
                <li class="tag-direct" :class="{ active: activeTab === 'factory' }" @click="activeTab = 'factory'">
                  {{ t('factoryDirect') }}
                </li>
              </ul>
            </div>

            <!-- ä¸€ä»¶ä»£å‘Tabå†…å®¹ -->
            <div v-show="activeTab === 'dropship'" class="tab-content dropship-content">
              <!-- ä»·æ ¼ä¸ä¼šå‘˜æŠ˜æ‰£åŒºåŸŸ -->
              <div class="product-pricing-section">
                <div class="price-display">
                  <p class="price-amount">
                    <b class="price-value">{{ currentCurrency }} {{ basePrice.toFixed(2) }}</b>
                    <span v-if="originalPrice > 0 && originalPrice > basePrice" class="original-price">{{ currentCurrency }} {{ originalPrice.toFixed(2) }}</span>
                  </p>
                </div>

                <div class="member-discount-box">
                  <p class="member-level">
                    <span class="level-name">
                      <template v-if="isLoggedIn">
                        {{ userVipLevelName }}
                      </template>
                      <template v-else>
                        <span>{{ t('memberDiscount') }}ï¼Œ</span>
                        <a href="/login" class="login-link">{{ t('login') }}</a>
                        <span>{{ t('afterViewDiscount') }}</span>
                      </template>
                    </span>
                    <template v-if="isLoggedIn && memberPrice > 0 && memberPrice < basePrice">
                      <span class="vip-price">{{ currentCurrency }} {{ memberPrice.toFixed(2) }}</span>
                      <span v-if="discountPercentText" class="discount-percent">{{ discountPercentText }}</span>
                    </template>
                    <template v-else-if="isLoggedIn">
                      <span class="no-discount-text">{{ t('noDiscountForLevel') }}</span>
                    </template>
                  </p>
                  <a target="_blank" href="/membership" class="member-link">{{ t('learnMoreMembership') }}</a>
                </div>
              </div>

              <!-- æ‰¹å‘è¯´æ˜åŒºåŸŸ -->
              <div class="wholesale-section">
                <div class="wholesale-content">
                  <h5 class="section-title">{{ t('wholesaleTitle') }}</h5>
                  <p class="section-description">
                    {{ t('wholesaleDescription') }}
                  </p>
                  <h5 class="section-title">{{ t('wholesaleProcessTitle') }}</h5>
                  <img loading="lazy" src="https://www.saleyee.com/ContentNew/Images/2023/202305/wholesale-guidance.png" class="workflow-image" :alt="t('wholesaleProcessTitle')" />
                  <div class="button-group">
                    <button type="button" class="btn-primary">{{ t('tryNow') }}</button>
                    <a target="_blank" href="https://www.saleyee.com/guide/hp746811.html" class="help-link">{{ t('viewMoreHelp') }} &gt;</a>
                  </div>
                </div>
              </div>

              <!-- å•†å“è¯¦æƒ…åˆ—è¡¨ -->
              <div class="product-details-list">
                <ul class="details-list-primary">
                  <li class="list-item">
                    <span class="item-label">{{ t('couponLabel') }}</span>
                    <div class="item-content">
                      <span class="coupon-badge">{{ couponText }}</span>
                    </div>
                  </li>

                  <li class="list-item">
                    <span class="item-label">{{ t('warehouseTypeLabel') }}</span>
                    <div class="item-content">{{ t('warehouseTypeSY') }}</div>
                  </li>

                  <li class="list-item">
                    <span class="item-label">{{ t('serviceLabel') }}</span>
                    <div class="item-services">
                      <span :class="['service-badge', product?.supportDropship ? 'supported' : 'unsupported']" :title="product?.supportDropship ? t('supportedService') + t('dropship') : t('unsupportedService') + t('dropship')">
                        <Check v-if="product?.supportDropship" class="service-icon" :size="16" :stroke-width="2" />
                        <X v-else class="service-icon" :size="16" :stroke-width="2" />
                        {{ t('dropship') }}
                      </span>
                      <span :class="['service-badge', product?.supportWholesale ? 'supported' : 'unsupported']" :title="product?.supportWholesale ? t('supportedService') + t('wholesale') : t('unsupportedService') + t('wholesale')">
                        <Check v-if="product?.supportWholesale" class="service-icon" :size="16" :stroke-width="2" />
                        <X v-else class="service-icon" :size="16" :stroke-width="2" />
                        {{ t('wholesale') }}
                      </span>
                      <span :class="['service-badge', product?.supportCircle_buy ? 'supported' : 'unsupported']" :title="product?.supportCircle_buy ? t('supportedService') + t('circleBuy') : t('unsupportedService') + t('circleBuy')">
                        <Check v-if="product?.supportCircle_buy" class="service-icon" :size="16" :stroke-width="2" />
                        <X v-else class="service-icon" :size="16" :stroke-width="2" />
                        {{ t('circleBuy') }}
                      </span>
                      <span :class="['service-badge', product?.supportSelf_pickup ? 'supported' : 'unsupported']" :title="product?.supportSelf_pickup ? t('supportedService') + t('selfPickup') : t('unsupportedService') + t('selfPickup')">
                        <Check v-if="product?.supportSelf_pickup" class="service-icon" :size="16" :stroke-width="2" />
                        <X v-else class="service-icon" :size="16" :stroke-width="2" />
                        {{ t('selfPickup') }}
                      </span>
                    </div>
                  </li>

                  <li class="list-item">
                    <span class="item-label">{{ t('shippingRegionLabel') }}</span>
                    <div class="item-content">
                      <div class="region-tags">
                        <em 
                          v-for="region in shippingRegions" 
                          :key="region.code" 
                          class="region-code"
                          :class="{ 'region-selected': selectedRegion === region.code }"
                          @click="selectRegion(region.code)"
                        >
                          {{ region.code }}
                        </em>
                      </div>
                    </div>
                  </li>
                </ul>

                <!-- å‘è´§ä¿¡æ¯åŒºåŸŸ -->
                <div class="details-list-secondary-wrapper">
                  <ul class="details-list-secondary">
                    <li class="list-item">
                      <span class="item-label">{{ t('shippingMethodLabel') }}</span>
                      <div class="item-content">
                        <div class="logistics-select">
                          <select class="select-dropdown" v-model="selectedShippingMethod">
                            <option value="STANDARD_SHIPPING">{{ t('standardShipping') }}</option>
                            <option value="SELF_PICKUP">{{ t('selfPickupOption') }}</option>
                          </select>
                          <span class="shipping-time">{{ t('estimatedTime') }}ï¼Œ{{ formattedShippingFee }}</span>
                        </div>
                      </div>
                    </li>

                    <li class="list-item">
                      <span class="item-label">{{ t('quantityLabel') }}</span>
                      <div class="item-content">
                        <div class="quantity-control" role="group" :aria-label="t('quantityLabel')">
                          <em class="quantity-btn" @click="decreaseQty" :aria-label="t('decreaseQuantity')">-</em>
                          <input
                            type="number"
                            class="quantity-input"
                            v-model.number="quantity"
                            :min="minOrderQuantity"
                            :aria-label="t('quantityLabel')"
                          />
                          <em class="quantity-btn" @click="increaseQty" :aria-label="t('increaseQuantity')">+</em>
                        </div>
                        <i class="stock-info">{{ t('stockLabel') }}<em class="stock-value">{{ currentStock }}</em></i>
                        <i v-if="quantityError" class="error-info">{{ quantityError }}</i>
                      </div>
                    </li>

                    <li class="list-item hidden">
                      <span class="item-label">{{ t('expectedPrice') }}<div class="price-help"><img loading="lazy" src="/images/icons/insurance.svg" class="help-icon" :alt="t('helpIconAlt')" /><div class="help-tooltip">{{ t('expectedPriceHelp') }}</div></div>ï¼š</span>
                      <div class="price-input-wrapper">
                        <div class="currency-input">
                          <span class="currency">USD</span>
                          <input type="text" :placeholder="t('expectedPriceOptional')" class="price-input" />
                        </div>
                        <i class="price-note">{{ t('expectedPriceNote') }}<em class="price-value">0</em></i>
                      </div>
                    </li>

                    <li class="list-item hidden">
                      <span class="item-label">{{ t('expectedQuantity') }}</span>
                      <div class="item-content">
                        <div class="quantity-control">
                          <em class="quantity-btn">--</em>
                          <input type="text" :placeholder="t('expectedQuantityRequired')" value="0" class="quantity-input" />
                          <em class="quantity-btn">+</em>
                        </div>
                        <i class="stock-info">{{ t('availableStock') }}<em class="stock-value">0</em></i>
                        <i class="stock-info">{{ t('suggestedMinOrder') }}<em class="stock-value">0</em></i>
                        <i class="stock-info">{{ t('estimatedPallets') }}<em class="stock-value">0</em></i>
                      </div>
                    </li>
                  </ul>
                </div>

                <!-- æ“ä½œæŒ‰é’®ç»„ -->
                <div class="action-buttons-wrapper">
                  <div class="button-group-primary">
                    <button 
                      type="button" 
                      class="btn-orange" 
                      @click="openPaymentModal"
                      :disabled="isCheckingAddress"
                      :class="{ 'btn-loading': isCheckingAddress }"
                    >
                      <svg v-if="isCheckingAddress" class="loading-spinner" viewBox="0 0 24 24">
                        <circle class="loading-circle" cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="3"/>
                      </svg>
                      <span>{{ isCheckingAddress ? (currentLang === 'en' ? 'Checking...' : 'æ£€æŸ¥ä¸­...') : t('buyNow') }}</span>
                    </button>
                    <button 
                      type="button" 
                      class="btn-secondary" 
                      @click="handleAddToCart"
                      :disabled="isAddingToCart"
                      :class="{ 'btn-loading': isAddingToCart }"
                    >
                      <svg v-if="isAddingToCart" class="loading-spinner" viewBox="0 0 24 24">
                        <circle class="loading-circle" cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="3"/>
                      </svg>
                      <span>{{ isAddingToCart ? t('adding') : t('addToCart') }}</span>
                    </button>
                    <OneClickPublishButton @open="isPublishModalOpen = true" />
                    <button type="button" class="btn-favorite" :title="t('addToFavorites')">
                      <img :title="t('addToFavorites')" loading="lazy" src="/frondend/images/ItemDetailPage/favorites_icon.png" class="btn-favorite-icon" :alt="t('addToFavorites')" />
                    </button>
                  </div>

                  <div class="button-group-secondary">
                    <button type="button" class="btn-link-text btn-download" @click="handleDownloadProduct" :disabled="isDownloading">
                      <svg class="btn-download-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                      </svg>
                      {{ isDownloading ? t('downloading') : t('downloadData') }}
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- å·¥å‚ç›´é‡‡Tabå†…å®¹ -->
            <div v-show="activeTab === 'factory'" class="tab-content factory-content">
              <div class="inquiry-form-container">
                <div class="form-header">
                  <h3 class="form-title">{{ t('factoryInquiryTitle') }}</h3>
                  <p class="form-subtitle">{{ t('factoryInquirySubtitle') }}</p>
                </div>
                
                <div class="form-body">
                  <!-- è”ç³»äººå§“åã€è”ç³»ç”µè¯ã€è¯¢ä»·æ•°é‡ï¼ˆåŒä¸€è¡Œï¼‰ -->
                  <div class="form-field-row">
                    <div class="form-field form-field-third">
                      <label class="field-label">
                        <span class="required-star">*</span>
                        {{ t('contactName') }}
                      </label>
                      <input 
                        v-model="inquiryForm.contactName" 
                        type="text" 
                        :placeholder="t('contactNamePlaceholder')" 
                        class="field-input"
                      />
                    </div>
                    
                    <div class="form-field form-field-third">
                      <label class="field-label">
                        <span class="required-star">*</span>
                        {{ t('contactPhone') }}
                      </label>
                      <input 
                        v-model="inquiryForm.contactPhone" 
                        type="text" 
                        :placeholder="t('contactPhonePlaceholder')" 
                        class="field-input"
                      />
                    </div>
                    
                    <div class="form-field form-field-third">
                      <label class="field-label">
                        <span class="required-star">*</span>
                        {{ t('inquiryQuantity') }}
                      </label>
                      <input 
                        v-model.number="inquiryForm.inquiryQuantity" 
                        type="number" 
                        :min="1"
                        :placeholder="t('inquiryQuantityPlaceholder')" 
                        class="field-input"
                      />
                    </div>
                  </div>
                  
                  <!-- éœ€æ±‚æè¿° -->
                  <div class="form-field">
                    <label class="field-label">
                      <span class="required-star">*</span>
                      {{ t('requirementDescription') }}
                    </label>
                    <textarea 
                      v-model="inquiryForm.requirementDescription" 
                      rows="4"
                      :placeholder="t('requirementDescriptionPlaceholder')" 
                      class="field-textarea"
                    ></textarea>
                  </div>
                  
                  <!-- é™„ä»¶ä¸Šä¼  -->
                  <div class="form-field">
                    <label class="field-label">
                      {{ t('uploadAttachment') }}
                    </label>
                    <InquiryFileUpload 
                      :key="fileUploadKey"
                      v-model="inquiryForm.attachments"
                      :max-files="10"
                      :translations="{
                        clickOrDragToUpload: t('clickOrDragToUpload'),
                        uploadHint: t('uploadAttachmentHint'),
                        filesUploaded: t('filesUploaded'),
                        imagePreview: t('imagePreview')
                      }"
                    />
                  </div>
                  
                  <!-- æäº¤æŒ‰é’® -->
                  <div class="form-actions">
                    <button 
                      type="button" 
                      class="submit-inquiry-btn"
                      :disabled="isSubmittingInquiry"
                      @click="handleSubmitInquiry"
                    >
                      {{ isSubmittingInquiry ? t('submitting') : t('submitInquiry') }}
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <RelatedProducts :products="relatedProducts" />
      <ProductDetailTabs :product="productForTabs" :plinfo="plinfo" />
    </main>

    <SiteFooter />
    <OneClickPublishModal
      :isOpen="isPublishModalOpen"
      :productId="product?.sku"
      @close="isPublishModalOpen = false"
      @publish="handlePublish"
    />
    <PaymentMethodModal
      :isOpen="isPaymentModalOpen"
      :productTitle="product?.title || ''"
      :productTitleEn="product?.titleEn || ''"
      :productImage="mainImageUrl"
      :quantity="quantity"
      :totalPrice="totalPrice"
      :priceBreakdown="priceBreakdown"
      :siteCurrency="siteCurrency"
      @close="isPaymentModalOpen = false"
      @confirm="handlePaymentConfirm"
    />
    
    <!-- è®¢å•çŠ¶æ€ç›‘æ§å¼¹çª— -->
    <OrderStatusMonitor
      :is-visible="showOrderMonitor"
      :order-no="processingOrderNo"
      @close="handleOrderMonitorClose"
      @ready="handleMercureReady"
      @payment-success="handlePaymentSuccess"
    />
  </div>
</template>

<style scoped>
.page {
  background-color: #f2f3f7;
}

.breadcrumb-wrapper {
  max-width: 1500px;
  min-width: 1200px;
  width: 80%;
  margin: 0 auto;
  background-color: #f2f3f7;
  padding: 10px 0;
}

.breadcrumb-container {
  display: flex;
  align-items: center;
  gap: 5px;
  line-height: 30px;
}

.breadcrumb-link {
  color: #999;
  text-decoration: none;
  padding: 0 5px;
  transition: color 0.3s;
  font-size: 14px;
}

.breadcrumb-link:hover {
  color: #ff6600;
}

.breadcrumb-arrow {
  color: #999;
  flex-shrink: 0;
}

.important-notice-wrapper {
  max-width: 1500px;
  min-width: 1200px;
  width: 80%;
  margin: 0 auto;
}

.content-container {
  max-width: 1500px;
  min-width: 1200px;
  width: 80%;
  margin: 0 auto;
  background-color: #ffffff;
  display: flex;
  overflow: hidden;
}

/* å·¦ä¾§å•†å“å›¾ç‰‡åŒºåŸŸ */
.product-section {
  flex: 0 0 500px;
  background-color: #ffffff;
}

.image-gallery-wrapper {
  position: relative;
  width: 500px;
}

.main-image-container {
  border: 1px solid #f1f1f1;
  height: 500px;
  overflow: hidden;
  position: relative;
  width: 500px;
}

.main-image {
  height: 500px;
  left: 50%;
  margin-left: -250px;
  position: absolute;
  vertical-align: middle;
  width: 500px;
  object-fit: cover;
}

.no-image-placeholder {
  height: 100%;
  position: relative;
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  background-color: #f5f5f5;
  color: #999;
}

.image-overlay {
  background-color: rgba(255, 255, 255, 0.5);
  display: none;
  height: 250px;
  position: absolute;
  width: 250px;
}

.thumbnail-navigation {
  overflow: visible;
  padding: 0;
  position: relative;
  margin-top: 15px;
  display: flex;
  align-items: center;
  gap: 0;
}

.nav-arrows {
  display: none;
}

.arrow-left {
  display: none;
}

.arrow-right {
  display: none;
}

.thumbnails-wrapper {
  overflow: visible;
  position: relative;
  padding: 0;
  flex: 1;
}

.thumbnail-scroll-container {
  display: grid;
  grid-template-columns: repeat(5, 88px);
  gap: 12px;
  position: relative;
  transform: none !important;
  width: fit-content;
  margin: 0 auto;
  list-style: none;
  padding: 0;
}

.thumbnail-item {
  cursor: pointer;
  width: 88px;
  height: 88px;
  list-style: none;
  margin: 0;
  padding: 0;
}

.thumbnail-image-wrapper {
  display: flex;
  width: 100%;
  height: 100%;
  align-items: center;
  justify-content: center;
  margin: 0;
  padding: 1px;
  text-align: center;
  border: 1px solid #ddd;
  transition: border-color 0.2s;
  box-sizing: border-box;
}

.thumbnail-image-wrapper:hover {
  border-color: #ff6600;
}

.thumbnail-image-wrapper.active {
  border-color: #ff6600;
}

.thumbnail-image {
  cursor: pointer;
  max-height: 100%;
  max-width: 100%;
  object-fit: cover;
}

.large-preview {
  background-color: #ffffff;
  border: 1px solid #f1f1f1;
  display: none;
  height: 500px;
  position: absolute;
  right: -100.5%;
  top: 0;
  width: 500px;
  z-index: 9999;
  overflow: hidden;
}

.large-preview-image {
  height: 1000px;
  width: 1000px;
  object-fit: cover;
}

/* å³ä¾§å•†å“è¯¦æƒ…åŒºåŸŸ */
.product-details-section {
  padding: 0 20px 20px;
  vertical-align: top;
  width: calc(100% - 500px);
}

.warning-banner {
  background-color: #fff7f6;
  display: none;
  margin-top: 20px;
  padding: 13px;
  border-radius: 4px;
}

.warning-icon {
  display: inline-block;
  height: 19px;
  margin-right: 11px;
  vertical-align: middle;
}

.warning-text {
  color: #cb261c;
  line-height: 20px;
  margin: 0;
}

.product-info-wrapper {
  width: 100%;
}

/* å•†å“æ ‡é¢˜ä¿¡æ¯ */
.product-header {
  width: 100%;
}

.product-title {
  color: #000;
  font-size: 16px;
  font-weight: 700;
  line-height: 24px;
  padding: 20px 0 5px 0;
  margin: 0;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.title-text {
  display: inline;
  font-weight: 700;
}

.product-subtitle {
  color: #999;
  line-height: 24px;
  margin: 0 0 10px 0;
  font-size: 14px;
}

.sku-info {
  color: #cb261c;
  display: inline-block;
  font-weight: 700;
  margin-bottom: 10px;
  margin-right: 20px;
  font-size: 13px;
}

.spu-info {
  display: inline;
  margin-right: 20px;
  font-size: 13px;
  color: #666;
}

.publish-date {
  display: inline;
  font-size: 13px;
  color: #666;
}

/* å•†å“æ ‡ç­¾/Tabèœå• */
.product-tags {
  width: 100%;
  margin-top: 10px;
}

.tags-list {
  align-items: center;
  background-color: #f5f5f5;
  display: flex;
  height: 52px;
  margin: 10px 0;
  padding: 0;
  list-style: none;
  gap: 0;
  justify-content: flex-start;
}

.tag-dropship,
.tag-direct {
  cursor: pointer;
  font-size: 16px;
  font-weight: 700;
  line-height: 44px;
  min-width: 118px;
  padding: 0 27px;
  text-align: center;
  margin: 0;
  list-style: none;
  border-top: 4px solid #f5f5f5;
  color: #333;
  transition: all 0.3s;
}

.tag-dropship {
  background-color: #fff;
}

.tag-direct {
  background-color: transparent;
}

.tag-dropship.active,
.tag-direct.active {
  background-color: #fff;
  border-top-color: #cb261c;
  color: #cb261c;
}

/* Tabå†…å®¹ */
.tab-content {
  animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

/* å·¥å‚ç›´é‡‡è¡¨å•æ ·å¼ */
.factory-form {
  margin-top: 20px;
}

.form-list {
  list-style: none;
  margin: 0;
  padding: 0;
}

.form-item {
  display: flex;
  margin-bottom: 16px;
}

.form-label {
  line-height: 38px;
  width: 180px;
  margin: 0;
  font-weight: 500;
  color: #333;
}

.required-mark {
  color: #ff0000;
  margin-right: 4px;
}

.form-control {
  flex: 1;
  max-width: calc(100% - 180px);
}

.form-input,
.form-textarea {
  width: 100%;
  border: 1px solid #e6e6e6;
  border-radius: 2px;
  padding: 6px 10px;
  font-size: 14px;
  font-family: inherit;
  transition: border-color 0.3s;
}

.form-input {
  height: 38px;
  line-height: 26px;
}

.form-textarea {
  min-height: 100px;
  resize: vertical;
  line-height: 20px;
}

.form-input:focus,
.form-textarea:focus {
  outline: none;
  border-color: #cb261c;
}

.upload-btn {
  background-color: #fff;
  border: 1px solid #c9c9c9;
  border-radius: 2px;
  color: #555;
  cursor: pointer;
  display: inline-block;
  height: 38px;
  line-height: 38px;
  padding: 0 18px;
  text-align: center;
  transition: all 0.3s;
  font-size: 14px;
}

.upload-btn:hover {
  border-color: #999;
  background-color: #f5f5f5;
}

.file-input {
  display: none !important;
}

.file-tip {
  display: block;
  color: #999;
  font-size: 12px;
  margin-top: 8px;
  line-height: 1.5;
}

.submit-btn {
  background-color: #cb261c;
  border: none;
  border-radius: 2px;
  color: #fff;
  cursor: pointer;
  display: inline-block;
  height: 38px;
  line-height: 38px;
  padding: 0 18px;
  text-align: center;
  transition: background-color 0.3s;
  font-size: 14px;
  font-weight: 600;
}

.submit-btn:hover {
  background-color: #b01f15;
}

/* ä»·æ ¼ä¸æŠ˜æ‰£åŒºåŸŸ */
.product-pricing-section {
  width: 100%;
  margin-top: 10px;
}

/* ä¸šåŠ¡ç±»å‹æ ‡ç­¾ */
.business-type-label {
  margin-bottom: 12px;
}

.type-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 12px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: #fff;
  font-size: 13px;
  border-radius: 4px;
  box-shadow: 0 2px 4px rgba(102, 126, 234, 0.2);
}

.type-badge strong {
  font-weight: 600;
  font-size: 14px;
}

.price-display {
  background-color: #fffbfb;
  padding: 15px 20px;
  margin-bottom: 10px;
  border-radius: 4px;
}

.price-amount {
  margin: 0;
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 24px;
}

.price-value {
  color: #cb261c;
  font-weight: 700;
  font-size: 24px;
}

.discount-percent {
  color: #999;
  font-size: 14px;
  font-weight: 400;
  margin-left: 5px;
}

.original-price {
  color: #999;
  text-decoration: line-through;
  font-size: 16px;
}

.member-discount-box {
  background-color: #fffbfb;
  border: 1px solid #ffeaea;
  border-radius: 4px;
  height: 44px;
  margin-bottom: 16px;
  padding: 0 15px;
  position: relative;
  display: flex;
  align-items: center;
  gap: 10px;
}

.member-level {
  display: inline-block;
  font-size: 16px;
  line-height: 44px;
  width: auto;
  margin: 0;
  display: flex;
  align-items: center;
  gap: 8px;
}

.level-name {
  font-size: 16px;
  color: #333;
}

.vip-price {
  color: #cb261c;
  font-weight: 600;
  font-size: 16px;
}

.discount-percent {
  color: #999;
  font-size: 12px;
  font-weight: 400;
}

.discount-text {
  display: inline;
  line-height: 44px;
  font-size: 13px;
  color: #666;
}

.member-link {
  color: #cb261c;
  position: absolute;
  right: 20px;
  text-decoration: none;
  transition: color 0.3s;
  font-size: 13px;
}

.member-link:hover {
  color: #b01f15;
}

.login-link {
  color: #d85850;
  text-decoration: none;
  transition: color 0.3s;
  font-size: 16px;
}

.login-link:hover {
  color: #cb261c;
  text-decoration: underline;
}

.no-discount-text {
  color: #999;
  font-size: 13px;
  margin-left: 10px;
}

/* æ‰¹å‘è¯´æ˜åŒºåŸŸ */
.wholesale-section {
  display: none;
  margin-bottom: 20px;
}

.wholesale-content {
  background-color: #ffffff;
  border: 2px solid #e6e6e6;
  padding: 24px;
  border-radius: 4px;
}

.section-title {
  color: #000;
  font-size: 16px;
  line-height: 24px;
  margin: 0 0 16px 0;
  font-weight: 600;
}

.section-description {
  color: #999;
  line-height: 20px;
  margin-bottom: 24px;
  font-size: 14px;
}

.workflow-image {
  display: inline-block;
  max-width: 100%;
  margin-bottom: 20px;
}

.button-group {
  margin-top: 20px;
}

.btn-primary {
  background-color: #cb261c;
  color: #fff;
  cursor: pointer;
  display: inline-block;
  height: 38px;
  line-height: 38px;
  margin-right: 24px;
  padding: 0 18px;
  text-align: center;
  border: none;
  border-radius: 2px;
  transition: background-color 0.3s;
  font-size: 14px;
}

.button-group .help-link {
  color: #cb261c;
  text-decoration: none;
  transition: color 0.3s;
  line-height: 38px;
  font-size: 14px;
}

/* å•†å“è¯¦æƒ…åˆ—è¡¨ */
.product-details-list {
  padding-left: 0;
  margin-top: 20px;
}

.details-list-primary {
  list-style: none;
  margin: 0;
  padding: 0;
}

.list-item {
  display: table;
  width: 100%;
  line-height: 30px;
  margin-bottom: 16px;
}

.list-item-hidden {
  display: none;
}

.item-label {
  display: table-cell;
  line-height: 1.5;
  vertical-align: middle;
  width: 150px;
  color: #666;
  font-size: 14px;
  font-weight: 500;
}

.item-content {
  display: table-cell;
  vertical-align: middle;
  width: calc(100% - 150px);
  line-height: 1.5;
}

.item-services {
  display: flex;
  align-items: center;
  flex-wrap: wrap;
  gap: 8px;
  line-height: 40px;
}

.coupon-badge {
  background-color: #ffededed;
  border: 1px solid #db1200;
  border-radius: 2px;
  color: #cb261c;
  display: inline-flex;
  height: 24px;
  line-height: 24px;
  padding: 0 10px;
  align-items: center;
  font-size: 13px;
  margin-bottom: 8px;
}

.service-badge {
  align-items: center;
  background-color: #ffffff;
  border: 1px solid #26bc00;
  border-radius: 3px;
  color: #26bc00;
  cursor: pointer;
  display: inline-flex;
  height: 24px;
  line-height: 24px;
  padding: 0 4px;
  position: relative;
  font-size: 13px;
  gap: 4px;
}

.service-badge.unsupported {
  border-color: #eb7e38;
  color: #eb7e38;
}

.service-icon {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

/* å‘è´§ä¿¡æ¯åŒºåŸŸ */
.details-list-secondary-wrapper {
  margin-top: 20px;
}

.details-list-secondary {
  list-style: none;
  margin: 0;
  padding: 0;
}

.region-tags {
  display: flex;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
}

.region-code {
  background-color: #ffededed;
  border: 1px solid #cb261c;
  border-radius: 3px;
  color: #cb261c;
  cursor: pointer;
  display: inline-table;
  line-height: 28px;
  padding: 0 10px;
  font-size: 13px;
  transition: all 0.3s;
}

.region-code:hover {
  background-color: #cb261c;
  color: #fff;
}

.region-code.region-selected {
  background-color: #cb261c;
  color: #fff;
  font-weight: 600;
}

.logistics-select {
  display: flex;
  align-items: center;
  gap: 15px;
  flex-wrap: wrap;
}

.select-dropdown {
  appearance: auto;
  background-color: #ffffff;
  border: 1px solid #d5d5d5;
  cursor: default;
  display: inline-block;
  height: 34px;
  padding: 0 5px;
  width: 220px;
  font-size: 13px;
  outline: none;
}

.select-dropdown:focus {
  outline: none;
  border-color: #cb261c;
}

.shipping-time {
  display: inline;
  color: #666;
  font-size: 13px;
  white-space: nowrap;
}

/* æ•°é‡å’Œä»·æ ¼æ§åˆ¶ */
.list-item.hidden {
  display: none;
}

.quantity-control {
  background-color: #fff;
  border: 1px solid #ddd;
  border-radius: 5px;
  display: inline-table;
  line-height: 24px;
}

.quantity-btn {
  color: #ccc;
  cursor: pointer;
  display: inline-table;
  font-family: arial;
  font-size: 18px;
  line-height: 28px;
  text-align: center;
  width: 26px;
}

.quantity-input {
  appearance: textfield;
  -moz-appearance: textfield;
  background-color: transparent;
  border: none;
  border-radius: 0;
  color: #333;
  cursor: text;
  display: inline-block;
  height: 34px;
  padding: 0;
  text-align: center;
  outline: none;
  box-shadow: none;
  width: 44px;
  font-size: 13px;
}

.quantity-input::-webkit-outer-spin-button,
.quantity-input::-webkit-inner-spin-button {
  -webkit-appearance: none;
  margin: 0;
}

.stock-info {
  color: #999;
  display: inline;
  line-height: 1.5;
  padding-left: 10px;
  vertical-align: middle;
  font-size: 13px;
}

.error-info {
  color: #cb261c;
  display: block;
  line-height: 1.5;
  padding-left: 10px;
  vertical-align: middle;
  font-size: 13px;
  margin-top: 5px;
}

.stock-value {
  display: inline;
}

.price-help {
  cursor: pointer;
  display: inline-block;
  position: relative;
  margin-left: 5px;
}

.help-icon {
  cursor: pointer;
  display: inline-block;
  filter: grayscale(1);
  vertical-align: middle;
  width: 18px;
  height: 18px;
}

.help-tooltip {
  background-color: #4e4e4e;
  border-radius: 3px;
  box-shadow: rgba(0, 0, 0, 0.2) 0 0 7px;
  color: #ffffff;
  display: none;
  left: -10px;
  padding: 5px;
  position: absolute;
  top: 25px;
  width: 200px;
  z-index: 9;
  font-size: 12px;
  line-height: 20px;
}

.price-input-wrapper {
  display: flex;
  align-items: center;
  gap: 15px;
}

.currency-input {
  align-items: center;
  background-color: #fff;
  border: 1px solid #ddd;
  border-radius: 3px;
  display: flex;
  line-height: 30px;
  padding: 0 8px;
  width: 150px;
  gap: 6px;
}

.currency {
  color: #999;
  font-size: 13px;
  white-space: nowrap;
}

.price-input {
  appearance: auto;
  background-color: #fff;
  border: none;
  border-radius: 2px;
  cursor: text;
  height: 34px;
  padding: 3px 5px;
  text-align: left;
  width: 94px;
  font-size: 13px;
  flex: 1;
}

.price-note {
  color: #999;
  font-size: 13px;
  line-height: 40px;
}

.price-value {
  color: #cb261c;
  font-weight: 700;
}

/* æ“ä½œæŒ‰é’® */
.action-buttons-wrapper {
  margin-top: 30px;
}

.button-group-primary {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 15px;
  margin-top: 15px;
}

.btn-secondary {
  appearance: auto;
  background-color: #cb261c;
  border: none;
  border-radius: 3px;
  color: #fff;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  height: 40px;
  line-height: 40px;
  padding: 0 18px;
  text-align: center;
  transition: background-color 0.3s;
  font-size: 14px;
  white-space: nowrap;
  min-width: 150px;
  position: relative;
}

.btn-secondary:hover:not(:disabled) {
  background-color: #b01f15;
}

.btn-secondary:disabled {
  opacity: 0.7;
  cursor: not-allowed;
}

.btn-secondary.btn-loading {
  pointer-events: none;
}

.btn-orange:disabled,
.btn-orange.btn-loading {
  opacity: 0.6;
  cursor: not-allowed;
  pointer-events: none;
}

.btn-orange .loading-spinner {
  margin-right: 6px;
}

.loading-spinner {
  width: 16px;
  height: 16px;
  animation: spin 1s linear infinite;
}

.loading-circle {
  stroke-dasharray: 63;
  stroke-dashoffset: 0;
  animation: dash 1.5s ease-in-out infinite;
}

@keyframes spin {
  0% {
    transform: rotate(0deg);
  }
  100% {
    transform: rotate(360deg);
  }
}

@keyframes dash {
  0% {
    stroke-dashoffset: 63;
  }
  50% {
    stroke-dashoffset: 15.75;
  }
  100% {
    stroke-dashoffset: 63;
  }
}

.btn-orange {
  align-items: center;
  appearance: auto;
  background-color: #ff6f00;
  border: none;
  border-radius: 3px;
  color: #fff;
  cursor: pointer;
  display: inline-flex;
  height: 40px;
  justify-content: center;
  line-height: 40px;
  padding: 0 18px;
  text-align: center;
  transition: background-color 0.3s;
  font-size: 14px;
  white-space: nowrap;
}

.btn-orange:hover {
  background-color: #e55d00;
}

.btn-publish {
  appearance: auto;
  background-color: #ffffff;
  border: 1px solid #d5d5d5;
  border-radius: 3px;
  cursor: pointer;
  display: inline-flex;
  height: 40px;
  align-items: center;
  gap: 6px;
  padding: 0 12px;
  text-align: center;
  transition: all 0.3s;
  font-size: 14px;
  color: #333;
  white-space: nowrap;
}

.btn-publish:hover {
  border-color: #999;
  background-color: #f5f5f5;
}

.btn-publish-icon {
  cursor: pointer;
  width: 18px;
  height: 18px;
  flex-shrink: 0;
}

.btn-favorite {
  appearance: auto;
  border: 1px solid #ccc;
  border-radius: 3px;
  cursor: pointer;
  height: 40px;
  width: 40px;
  padding: 0;
  text-align: center;
  transition: all 0.3s;
  background-color: transparent;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}

.btn-favorite:hover {
  border-color: #999;
}

.btn-favorite-icon {
  cursor: pointer;
  width: 20px;
  height: 20px;
}

.button-group-secondary {
  display: flex;
  flex-wrap: wrap;
  margin-top: 20px;
  gap: 24px;
}

.btn-link-text {
  appearance: auto;
  background-color: transparent;
  border: none;
  cursor: pointer;
  display: inline-block;
  height: 34px;
  line-height: 34px;
  padding: 0;
  text-align: center;
  transition: color 0.3s;
  color: #666;
  font-size: 14px;
}

.btn-link-text:hover {
  color: #999;
}

.btn-download {
  display: inline-flex;
  align-items: center;
  gap: 6px;
}

.btn-download-icon {
  width: 16px;
  height: 16px;
  flex-shrink: 0;
  transition: color 0.3s;
}

.btn-download:hover {
  color: #8B0000;
}

.btn-download:hover .btn-download-icon {
  color: #8B0000;
}

.btn-link-feedback {
  appearance: auto;
  background-color: transparent;
  border: none;
  color: #cb261c;
  cursor: pointer;
  display: inline-flex;
  height: 34px;
  line-height: 34px;
  padding: 0;
  text-align: center;
  transition: color 0.3s;
  align-items: center;
  gap: 4px;
  font-size: 14px;
}

.btn-link-feedback:hover {
  color: #b01f15;
}

.btn-link-icon {
  cursor: pointer;
  display: inline-block;
  width: 20px;
  height: 20px;
  flex-shrink: 0;
}


/* å·¥å‚ç›´é‡‡è¯¢ä»·è¡¨å•æ ·å¼ */
.inquiry-form-container {
  padding: 30px;
  background-color: #fff;
}

.form-header {
  margin-bottom: 30px;
  border-bottom: 1px solid #e5e7eb;
  padding-bottom: 20px;
}

.form-title {
  font-size: 20px;
  font-weight: 600;
  color: #111827;
  margin: 0 0 8px 0;
}

.form-subtitle {
  font-size: 14px;
  color: #6b7280;
  margin: 0;
}

.form-body {
  display: flex;
  flex-direction: column;
  gap: 24px;
}

.form-field-row {
  display: flex;
  gap: 16px;
}

.form-field {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.form-field-half {
  flex: 1;
  min-width: 0;
}

.form-field-third {
  flex: 1;
  min-width: 0;
}

.field-label {
  font-size: 14px;
  font-weight: 500;
  color: #374151;
  display: flex;
  align-items: center;
  gap: 4px;
}

.required-star {
  color: #cb261c;
  font-size: 16px;
}

.field-input,
.field-textarea {
  width: 100%;
  padding: 10px 12px;
  border: 1px solid #d1d5db;
  border-radius: 6px;
  font-size: 14px;
  color: #111827;
  transition: border-color 0.3s, box-shadow 0.3s;
  outline: none;
}

.field-input:focus,
.field-textarea:focus {
  border-color: #cb261c;
  box-shadow: 0 0 0 3px rgba(203, 38, 28, 0.1);
}

.field-input::placeholder,
.field-textarea::placeholder {
  color: #9ca3af;
}

.field-textarea {
  resize: vertical;
  min-height: 100px;
}

.form-actions {
  margin-top: 10px;
  padding-top: 20px;
  border-top: 1px solid #e5e7eb;
}

.submit-inquiry-btn {
  padding: 12px 32px;
  background-color: #cb261c;
  color: #fff;
  border: none;
  border-radius: 6px;
  font-size: 15px;
  font-weight: 500;
  cursor: pointer;
  transition: background-color 0.3s, transform 0.1s;
  outline: none;
}

.submit-inquiry-btn:hover:not(:disabled) {
  background-color: #a61e16;
  transform: translateY(-1px);
}

.submit-inquiry-btn:active:not(:disabled) {
  transform: translateY(0);
}

.submit-inquiry-btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

/* å“åº”å¼è°ƒæ•´ */
@media (max-width: 1200px) {
  .content-container,
  .breadcrumb-wrapper,
  .important-notice-wrapper {
    width: 95%;
  }
}

@media (max-width: 768px) {
  .content-container {
    flex-direction: column;
  }

  .product-section {
    flex: 1 1 auto;
  }

  .product-details-section {
    width: 100%;
  }

  .tags-list {
    flex-direction: column;
    height: auto;
  }

  .tag-dropship,
  .tag-direct {
    width: 100%;
  }

  .form-item {
    flex-direction: column;
  }

  .form-label {
    width: 100%;
    margin-bottom: 8px;
  }

  .form-control {
    width: 100%;
    max-width: 100%;
  }
  
  .inquiry-form-container {
    padding: 20px 15px;
  }
  
  .form-title {
    font-size: 18px;
  }
  
  .form-field-row {
    flex-direction: column;
    gap: 24px;
  }
  
  .submit-inquiry-btn {
    width: 100%;
  }
}
</style>
