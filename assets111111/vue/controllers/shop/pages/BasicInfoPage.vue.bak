<template>
  <div class="bg-white rounded-b-lg border-x border-b border-slate-200 p-6">
    <!-- 标题和重要提醒 -->
    <div class="mb-6">
      <h3 class="text-sm font-semibold text-slate-900 mb-4">{{ t('pageTitle') }}</h3>
      
      <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
        <p class="text-sm text-yellow-800">
          <span class="font-semibold">{{ t('importantNotice') }}</span>{{ t('noticeContent') }}
          <a 
            v-if="privacyPolicyResource" 
            class="text-primary hover:underline" 
            :href="privacyPolicyResource?.helpFaqId ? '/help-center?faqid=' + privacyPolicyResource.helpFaqId : ''"
            target="_blank"
            rel="noreferrer"
            v-text="currentLang === 'en' && privacyPolicyResource?.titleEn ? privacyPolicyResource.titleEn : privacyPolicyResource?.title || privacyPolicyResource?.title"
          ></a>{{ t('noticeProtected') }}
        </p>
      </div>
    </div>

    <!-- 账户类型选择 -->
    <form class="space-y-6 max-w-2xl">
      <div class="flex gap-4">
        <label class="flex items-center gap-2 cursor-pointer">
          <input type="radio" v-model="formData.accountType" value="personal" class="w-4 h-4 accent-primary" :disabled="!canSwitchAccountType" />
          <span class="text-sm text-slate-700">{{ t('accountTypePersonal') }}</span>
        </label>
        <label class="flex items-center gap-2 cursor-pointer">
          <input type="radio" v-model="formData.accountType" value="enterprise" class="w-4 h-4 accent-primary" :disabled="!canSwitchAccountType" />
          <span class="text-sm text-slate-700">{{ t('accountTypeEnterprise') }}</span>
        </label>
      </div>
      
      <!-- 升级提示 -->
      <div v-if="isVerified && user.customerType === 'individual' && formData.accountType === 'enterprise'" class="bg-green-50 border border-green-200 rounded-lg p-4">
        <p class="text-sm text-green-800">
          <span class="font-semibold">{{ t('upgradeNotice') }}</span>{{ t('upgradeContent') }}
        </p>
      </div>

      <!-- ==================== 个人信息部分 ==================== -->
      <div v-if="formData.accountType === 'personal'" class="border-t border-slate-200 pt-6">
        <h4 class="text-sm font-semibold text-slate-900 mb-6">{{ t('personalInfoTitle') }}</h4>

        <!-- 姓名 -->
        <div class="flex gap-4 mb-6">
          <label class="w-24 text-sm font-semibold text-slate-900 text-right pt-2">
            <span class="text-red-500">*</span> {{ t('labelName') }}
          </label>
          <div class="flex-1">
            <input
              v-model="formData.personalInfo.realName"
              type="text"
              :placeholder="t('placeholderName')"
              class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
              :disabled="!isEditable"
            />
          </div>
        </div>

        <!-- 性别 -->
        <div class="flex gap-4 mb-6">
          <label class="w-24 text-sm font-semibold text-slate-900 text-right pt-2">
            <span class="text-red-500">*</span> {{ t('labelGender') }}
          </label>
          <div class="flex-1 flex gap-4">
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="radio" v-model="formData.personalInfo.gender" value="1" class="w-4 h-4 accent-primary" :disabled="!isEditable" />
              <span class="text-sm text-slate-700">{{ t('genderMale') }}</span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="radio" v-model="formData.personalInfo.gender" value="2" class="w-4 h-4 accent-primary" :disabled="!isEditable" />
              <span class="text-sm text-slate-700">{{ t('genderFemale') }}</span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="radio" v-model="formData.personalInfo.gender" value="0" class="w-4 h-4 accent-primary" :disabled="!isEditable" />
              <span class="text-sm text-slate-700">{{ t('genderUnknown') }}</span>
            </label>
          </div>
        </div>

        <!-- 生日 -->
        <div class="flex gap-4 mb-6">
          <label class="w-24 text-sm font-semibold text-slate-900 text-right pt-2">
            <span class="text-red-500">*</span> {{ t('labelBirthday') }}
          </label>
          <div class="flex-1">
            <DatePicker
              v-model="formData.personalInfo.birthday"
              :placeholder="t('placeholderBirthday')"
              :disable-future="true"
              :disabled="!isEditable"
            />
          </div>
        </div>

        <!-- 个人身份证号 -->
        <div class="flex gap-4 mb-6">
          <label class="w-24 text-sm font-semibold text-slate-900 text-right pt-2">
            <span class="text-red-500">*</span> {{ t('labelIdCard') }}
          </label>
          <div class="flex-1">
            <input
              v-model="formData.personalInfo.individualIdCard"
              type="text"
              :placeholder="t('placeholderIdCard')"
              class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
              :disabled="!isEditable"
            />
          </div>
        </div>

        <!-- 个人身份证正面照片 -->
        <div class="flex gap-4 mb-6">
          <label class="w-24 text-sm font-semibold text-slate-900 text-right pt-2">
            <span class="text-red-500">*</span> {{ t('labelIdFront') }}
          </label>
          <div class="flex-1">
            <ImageUpload
              v-model="formData.personalInfo.individualIdFront"
              :label="t('labelIdFront')"
              :disabled="!isEditable"
            />
          </div>
        </div>

        <!-- 个人身份证反面照片 -->
        <div class="flex gap-4 mb-6">
          <label class="w-24 text-sm font-semibold text-slate-900 text-right pt-2">
            <span class="text-red-500">*</span> {{ t('labelIdBack') }}
          </label>
          <div class="flex-1">
            <ImageUpload
              v-model="formData.personalInfo.individualIdBack"
              :label="t('labelIdBack')"
              :disabled="!isEditable"
            />
          </div>
        </div>

        <!-- 详细地址 - 选填 -->
        <div class="border-t border-slate-200 pt-6">
          <h5 class="text-sm font-semibold text-slate-900 mb-4">{{ t('addressOptionalTitle') }}</h5>

          <div class="flex gap-4 mb-6">
            <label class="w-24 text-sm font-semibold text-slate-900 text-right pt-2">{{ t('labelAddress') }}</label>
            <div class="flex-1">
              <textarea
                v-model="formData.personalInfo.address"
                :placeholder="t('placeholderAddress')"
                rows="2"
                class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                :disabled="!isEditable"
              ></textarea>
            </div>
          </div>
        </div>
      </div>

      <!-- ==================== 企业信息部分 ==================== -->
      <div v-if="formData.accountType === 'enterprise'" class="border-t border-slate-200 pt-6">
        <h4 class="text-sm font-semibold text-slate-900 mb-6">{{ t('enterpriseInfoTitle') }}</h4>

        <!-- 公司名称 -->
        <div class="flex gap-4 mb-6">
          <label class="w-24 text-sm font-semibold text-slate-900 text-right pt-2">
            <span class="text-red-500">*</span> {{ t('labelCompanyName') }}
          </label>
          <div class="flex-1">
            <input
              v-model="formData.enterpriseInfo.companyName"
              type="text"
              :placeholder="t('placeholderCompanyName')"
              class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
              :disabled="!isEditable"
            />
          </div>
        </div>

        <!-- 公司类型 -->
        <div class="flex gap-4 mb-6">
          <label class="w-24 text-sm font-semibold text-slate-900 text-right pt-2">
            <span class="text-red-500">*</span> {{ t('labelCompanyType') }}
          </label>
          <div class="flex-1 flex flex-wrap gap-4">
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="radio" v-model="formData.enterpriseInfo.companyType" value="factory" class="w-4 h-4 accent-primary" :disabled="!isEditable" />
              <span class="text-sm text-slate-700">{{ t('companyTypeFactory') }}</span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="radio" v-model="formData.enterpriseInfo.companyType" value="trader" class="w-4 h-4 accent-primary" :disabled="!isEditable" />
              <span class="text-sm text-slate-700">{{ t('companyTypeTrader') }}</span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="radio" v-model="formData.enterpriseInfo.companyType" value="factory_trader" class="w-4 h-4 accent-primary" :disabled="!isEditable" />
              <span class="text-sm text-slate-700">{{ t('companyTypeFactoryTrader') }}</span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="radio" v-model="formData.enterpriseInfo.companyType" value="brand" class="w-4 h-4 accent-primary" :disabled="!isEditable" />
              <span class="text-sm text-slate-700">{{ t('companyTypeBrand') }}</span>
            </label>
          </div>
        </div>

        <!-- 营业执照注册号 -->
        <div class="flex gap-4 mb-6">
          <label class="w-24 text-sm font-semibold text-slate-900 text-right pt-2">
            <span class="text-red-500">*</span> {{ t('labelBusinessLicense') }}
          </label>
          <div class="flex-1">
            <input
              v-model="formData.enterpriseInfo.businessLicenseNumber"
              type="text"
              :placeholder="t('placeholderBusinessLicense')"
              class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
              :disabled="!isEditable"
            />
          </div>
        </div>

        <!-- 营业执照照片 -->
        <div class="flex gap-4 mb-6">
          <label class="w-24 text-sm font-semibold text-slate-900 text-right pt-2">
            <span class="text-red-500">*</span> {{ t('labelBusinessLicenseImage') }}
          </label>
          <div class="flex-1">
            <ImageUpload
              v-model="formData.enterpriseInfo.businessLicenseImage"
              :label="t('labelBusinessLicenseImage')"
              :disabled="!isEditable"
            />
          </div>
        </div>

        <!-- 法人姓名 -->
        <div class="flex gap-4 mb-6">
          <label class="w-24 text-sm font-semibold text-slate-900 text-right pt-2">
            <span class="text-red-500">*</span> {{ t('labelLegalPersonName') }}
          </label>
          <div class="flex-1">
            <input
              v-model="formData.enterpriseInfo.legalPersonName"
              type="text"
              :placeholder="t('placeholderLegalPersonName')"
              class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
              :disabled="!isEditable"
            />
          </div>
        </div>

        <!-- 法人身份证号 -->
        <div class="flex gap-4 mb-6">
          <label class="w-24 text-sm font-semibold text-slate-900 text-right pt-2">
            <span class="text-red-500">*</span> {{ t('labelLegalPersonIdCard') }}
          </label>
          <div class="flex-1">
            <input
              v-model="formData.enterpriseInfo.legalPersonIdCard"
              type="text"
              :placeholder="t('placeholderLegalPersonIdCard')"
              class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
              :disabled="!isEditable"
            />
          </div>
        </div>

        <!-- 法人身份证正面照片 -->
        <div class="flex gap-4 mb-6">
          <label class="w-24 text-sm font-semibold text-slate-900 text-right pt-2">
            <span class="text-red-500">*</span> {{ t('labelLegalPersonIdFront') }}
          </label>
          <div class="flex-1">
            <ImageUpload
              v-model="formData.enterpriseInfo.legalPersonIdFront"
              :label="t('labelLegalPersonIdFront')"
              :disabled="!isEditable"
            />
          </div>
        </div>

        <!-- 法人身份证反面照片 -->
        <div class="flex gap-4 mb-6">
          <label class="w-24 text-sm font-semibold text-slate-900 text-right pt-2">
            <span class="text-red-500">*</span> {{ t('labelLegalPersonIdBack') }}
          </label>
          <div class="flex-1">
            <ImageUpload
              v-model="formData.enterpriseInfo.legalPersonIdBack"
              :label="t('labelLegalPersonIdBack')"
              :disabled="!isEditable"
            />
          </div>
        </div>

        <!-- 注册资本 -->
        <div class="flex gap-4 mb-6">
          <label class="w-24 text-sm font-semibold text-slate-900 text-right pt-2">
            <span class="text-red-500">*</span> {{ t('labelRegisteredCapital') }}
          </label>
          <div class="flex-1 flex gap-2">
            <input
              v-model="formData.enterpriseInfo.registeredCapital"
              type="number"
              :placeholder="t('placeholderRegisteredCapital')"
              class="flex-1 px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
              :disabled="!isEditable"
            />
            <span class="text-sm text-slate-700 pt-2">{{ t('unitCapital') }}</span>
          </div>
        </div>

        <!-- 公司成立日期 -->
        <div class="flex gap-4 mb-6">
          <label class="w-24 text-sm font-semibold text-slate-900 text-right pt-2">
            <span class="text-red-500">*</span> {{ t('labelEstablishmentDate') }}
          </label>
          <div class="flex-1">
            <DatePicker
              v-model="formData.enterpriseInfo.establishmentDate"
              :placeholder="t('placeholderEstablishmentDate')"
              :disable-future="true"
              :disabled="!isEditable"
            />
          </div>
        </div>

        <!-- 经营范围 -->
        <div class="flex gap-4 mb-6">
          <label class="w-24 text-sm font-semibold text-slate-900 text-right pt-2">
            <span class="text-red-500">*</span> {{ t('labelBusinessScope') }}
          </label>
          <div class="flex-1">
            <textarea
              v-model="formData.enterpriseInfo.businessScope"
              :placeholder="t('placeholderBusinessScope')"
              rows="3"
              class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
              :disabled="!isEditable"
            ></textarea>
          </div>
        </div>

        <!-- 地址 - 必填 -->
        <div class="border-t border-slate-200 pt-6">
          <h5 class="text-sm font-semibold text-slate-900 mb-4">{{ t('companyAddressTitle') }}</h5>

          <!-- 详细地址 -->
          <div class="flex gap-4 mb-6">
            <label class="w-24 text-sm font-semibold text-slate-900 text-right pt-2">
              <span class="text-red-500">*</span> {{ t('labelAddress') }}
            </label>
            <div class="flex-1">
              <textarea
                v-model="formData.enterpriseInfo.address"
                :placeholder="t('placeholderAddress')"
                rows="2"
                class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                :disabled="!isEditable"
              ></textarea>
            </div>
          </div>
        </div>
      </div>

      <!-- 按钮 -->
      <div class="pt-6 ml-28">
        <button
          v-if="isEditable"
          @click="handleSubmit"
          type="button"
          :disabled="isSubmitting"
          class="submit-button"
        >
          <svg v-if="isSubmitting" class="loading-icon" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          <span>{{ isSubmitting ? t('buttonSubmitting') : t('buttonSubmit') }}</span>
        </button>
        <p v-else class="text-sm text-slate-500">{{ t('statusNotEditable') }}</p>
      </div>
    </form>
  </div>
</template>

<script setup>
import { reactive, computed, onMounted, onBeforeUnmount, ref } from 'vue'
import { ElMessage } from 'element-plus'
import ImageUpload from '@/components/ImageUpload.vue'
import DatePicker from '@/components/DatePicker.vue'
import apiSignature from '../services/apiSignature.js'

// 获取store实例
const store = window.vueStore

// 提交中状态
const isSubmitting = ref(false)

// 页面翻译数据
const translations = ref({})

// 当前语言 - 使用ref以便能响应事件更新
const currentLang = ref(localStorage.getItem('app.lang') || 'zh-CN')

// 隐私协议资源 (position为privacyPolicy, positiontype为legalDocuments)
const privacyPolicyResource = computed(() => {
  if (store && store.getters && store.getters.privacyPolicyResources) {
    const resources = store.getters.privacyPolicyResources
    if (Array.isArray(resources) && resources.length > 0) {
      return resources.find(resource =>
        resource.position === 'privacyPolicy' &&
        resource.positiontype === 'legalDocuments'
      )
    }
  }
  return null
})

// 监听语言变化事件
const handleLangChange = (event) => {
  if (event.detail && event.detail.lang) {
    currentLang.value = event.detail.lang
  }
  // 重新加载翻译以确保语言切换时更新
  loadTranslations()
}

// 获取用户信息
const user = computed(() => store?.state?.user || {})

// 加载翻译文件
const loadTranslations = async () => {
  try {
    const response = await fetch('/frondend/lang/BasicInfoPage.json')
    const data = await response.json()
    translations.value = data
  } catch (error) {
    console.error('Failed to load translations:', error)
  }
}

// 翻译函数 - 直接从页面特定的JSON文件读取
const t = (key) => {
  // 获取当前语言，优先从localStorage获取，否则使用默认值
  const lang = localStorage.getItem('app.lang') || currentLang.value
  
  // 从页面特定的翻译文件中获取翻译
  if (translations.value[lang] && translations.value[lang][key]) {
    return translations.value[lang][key]
  }
  
  // 如果没有找到翻译，返回键名
  return key
}

// 审核状态
const auditStatus = computed(() => user.value.auditStatus || 'resubmit')

// 实名状态
const isVerified = computed(() => user.value.isVerified || false)

// 是否可编辑逻辑：
// 1. 未实名 + resubmit：可以编辑所有信息
// 2. 已实名个人用户 + 选择企业类型：可以填写企业信息（升级为企业用户）
// 3. 已实名企业用户：不可编辑
const isEditable = computed(() => {
  // 未实名且审核状态为resubmit：可以编辑
  if (!isVerified.value && auditStatus.value === 'resubmit') {
    return true
  }
  
  // 已实名的个人用户，选择了企业类型：允许填写企业信息（升级）
  if (isVerified.value && 
      user.value.customerType === 'individual' && 
      formData.accountType === 'enterprise') {
    return true
  }
  
  return false
})

// 账户类型是否可切换：已实名的个人用户可以升级为企业
const canSwitchAccountType = computed(() => {
  // 未实名：可以自由切换
  if (!isVerified.value && auditStatus.value === 'resubmit') {
    return true
  }
  
  // 已实名的个人用户：可以升级为企业
  if (isVerified.value && user.value.customerType === 'individual') {
    return true
  }
  
  // 已实名的企业用户：不允许切换
  return false
})

// 将customerType映射到accountType
// customerType: 'individual'-个人, 'company'-企业
// accountType: 'personal'-个人, 'enterprise'-企业
const getAccountType = () => {
  const customerType = user.value.customerType || 'individual'
  return customerType === 'individual' ? 'personal' : 'enterprise'
}

const formData = reactive({
  accountType: getAccountType(),
  personalInfo: {
    realName: '',
    gender: '1',
    birthday: '',
    individualIdCard: '',
    individualIdFront: '',
    individualIdBack: '',
    address: '',
  },
  enterpriseInfo: {
    companyName: '',
    companyType: '',
    businessLicenseNumber: '',
    businessLicenseImage: '',
    legalPersonName: '',
    legalPersonIdCard: '',
    legalPersonIdFront: '',
    legalPersonIdBack: '',
    registeredCapital: '',
    establishmentDate: '',
    businessScope: '',
    address: '',
  },
})

// 组件挂载时，根据store中的会员类型更新accountType并加载用户数据
onMounted(() => {
  // 初始加载翻译
  loadTranslations()
  
  formData.accountType = getAccountType()
  loadUserData()
  console.log('用户会员类型:', user.value.customerType, '-> 表单类型:', formData.accountType)
  
  // 监听语言变化事件
  window.addEventListener('languagechange', handleLangChange)
  
  // 加载公共资源数据
  if (store && store.dispatch) {
    // 检查是否需要加载数据
    const lastUpdated = store.state.publicResources?.lastUpdated
    let shouldLoad = false
    
    if (!lastUpdated) {
      shouldLoad = true
    } else {
      const lastUpdatedTime = new Date(lastUpdated)
      const now = new Date()
      const diffMinutes = (now - lastUpdatedTime) / (1000 * 60)
      shouldLoad = diffMinutes >= 5
    }
    
    // 如果需要加载数据，则一次性加载所有公共资源
    if (shouldLoad) {
      store.dispatch('loadPublicResources')
    }
  }
})

// 加载用户数据到表单
const loadUserData = () => {
  if (!user.value.id) return
  
  // 加载个人信息
  if (formData.accountType === 'personal') {
    formData.personalInfo.realName = user.value.realName || ''
    formData.personalInfo.gender = user.value.gender ? String(user.value.gender) : '1'
    formData.personalInfo.birthday = user.value.birthday || ''
    formData.personalInfo.individualIdCard = user.value.individualIdCard || ''
    formData.personalInfo.individualIdFront = user.value.individualIdFront || ''
    formData.personalInfo.individualIdBack = user.value.individualIdBack || ''
    formData.personalInfo.address = user.value.address || ''
  }
  
  // 加载企业信息
  if (formData.accountType === 'enterprise') {
    formData.enterpriseInfo.companyName = user.value.companyName || ''
    formData.enterpriseInfo.companyType = user.value.companyType || ''
    formData.enterpriseInfo.businessLicenseNumber = user.value.businessLicenseNumber || ''
    formData.enterpriseInfo.businessLicenseImage = user.value.businessLicenseImage || ''
    formData.enterpriseInfo.legalPersonName = user.value.legalPersonName || ''
    formData.enterpriseInfo.legalPersonIdCard = user.value.legalPersonIdCard || ''
    formData.enterpriseInfo.legalPersonIdFront = user.value.legalPersonIdFront || ''
    formData.enterpriseInfo.legalPersonIdBack = user.value.legalPersonIdBack || ''
    formData.enterpriseInfo.registeredCapital = user.value.registeredCapital || ''
    formData.enterpriseInfo.establishmentDate = user.value.establishmentDate || ''
    formData.enterpriseInfo.businessScope = user.value.businessScope || ''
    formData.enterpriseInfo.address = user.value.address || ''
  }
}

// 验证必填项
const validateForm = () => {
  if (formData.accountType === 'personal') {
    // 个人必填项
    if (!formData.personalInfo.realName?.trim()) {
      ElMessage.error(t('errorNameRequired'))
      return false
    }
    if (!formData.personalInfo.birthday) {
      ElMessage.error(t('errorBirthdayRequired'))
      return false
    }
    if (!formData.personalInfo.individualIdCard?.trim()) {
      ElMessage.error(t('errorIdCardRequired'))
      return false
    }
    // 验证身份证格式
    const idCardReg = /(^\d{15}$)|(^\d{18}$)|(^\d{17}(\d|X|x)$)/
    if (!idCardReg.test(formData.personalInfo.individualIdCard)) {
      ElMessage.error(t('errorIdCardInvalid'))
      return false
    }
    if (!formData.personalInfo.individualIdFront) {
      ElMessage.error(t('errorIdFrontRequired'))
      return false
    }
    if (!formData.personalInfo.individualIdBack) {
      ElMessage.error(t('errorIdBackRequired'))
      return false
    }
  } else {
    // 企业必填项
    if (!formData.enterpriseInfo.companyName?.trim()) {
      ElMessage.error(t('errorCompanyNameRequired'))
      return false
    }
    if (!formData.enterpriseInfo.companyType) {
      ElMessage.error(t('errorCompanyTypeRequired'))
      return false
    }
    if (!formData.enterpriseInfo.businessLicenseNumber?.trim()) {
      ElMessage.error(t('errorBusinessLicenseRequired'))
      return false
    }
    if (!formData.enterpriseInfo.businessLicenseImage) {
      ElMessage.error(t('errorBusinessLicenseImageRequired'))
      return false
    }
    if (!formData.enterpriseInfo.legalPersonName?.trim()) {
      ElMessage.error(t('errorLegalPersonNameRequired'))
      return false
    }
    if (!formData.enterpriseInfo.legalPersonIdCard?.trim()) {
      ElMessage.error(t('errorLegalPersonIdCardRequired'))
      return false
    }
    // 验证法人身份证格式
    const idCardReg = /(^\d{15}$)|(^\d{18}$)|(^\d{17}(\d|X|x)$)/
    if (!idCardReg.test(formData.enterpriseInfo.legalPersonIdCard)) {
      ElMessage.error(t('errorLegalPersonIdCardInvalid'))
      return false
    }
    if (!formData.enterpriseInfo.legalPersonIdFront) {
      ElMessage.error(t('errorLegalPersonIdFrontRequired'))
      return false
    }
    if (!formData.enterpriseInfo.legalPersonIdBack) {
      ElMessage.error(t('errorLegalPersonIdBackRequired'))
      return false
    }
    if (!formData.enterpriseInfo.registeredCapital) {
      ElMessage.error(t('errorRegisteredCapitalRequired'))
      return false
    }
    if (!formData.enterpriseInfo.establishmentDate) {
      ElMessage.error(t('errorEstablishmentDateRequired'))
      return false
    }
    if (!formData.enterpriseInfo.businessScope?.trim()) {
      ElMessage.error(t('errorBusinessScopeRequired'))
      return false
    }
    if (!formData.enterpriseInfo.address?.trim()) {
      ElMessage.error(t('errorCompanyAddressRequired'))
      return false
    }
  }
  return true
}

// 提交审核
const handleSubmit = async () => {
  // 验证表单
  if (!validateForm()) {
    return
  }
  
  // 设置提交中状态
  isSubmitting.value = true
  
  try {
    // 准备提交数据
    const submitData = formData.accountType === 'personal' 
      ? {
          customerType: 'individual',
          realName: formData.personalInfo.realName,
          gender: parseInt(formData.personalInfo.gender),
          birthday: formData.personalInfo.birthday,
          individualIdCard: formData.personalInfo.individualIdCard,
          individualIdFront: formData.personalInfo.individualIdFront,
          individualIdBack: formData.personalInfo.individualIdBack,
          address: formData.personalInfo.address || null,
        }
      : {
          customerType: 'company',
          companyName: formData.enterpriseInfo.companyName,
          companyType: formData.enterpriseInfo.companyType,
          businessLicenseNumber: formData.enterpriseInfo.businessLicenseNumber,
          businessLicenseImage: formData.enterpriseInfo.businessLicenseImage,
          legalPersonName: formData.enterpriseInfo.legalPersonName,
          legalPersonIdCard: formData.enterpriseInfo.legalPersonIdCard,
          legalPersonIdFront: formData.enterpriseInfo.legalPersonIdFront,
          legalPersonIdBack: formData.enterpriseInfo.legalPersonIdBack,
          registeredCapital: formData.enterpriseInfo.registeredCapital,
          establishmentDate: formData.enterpriseInfo.establishmentDate,
          businessScope: formData.enterpriseInfo.businessScope,
          address: formData.enterpriseInfo.address,
        }
    
    // 添加API签名
    const signedData = apiSignature.sign(submitData)
    
    const response = await fetch('/shop/api/customer/profile/update', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Requested-With': 'XMLHttpRequest'
      },
      credentials: 'include',
      body: JSON.stringify(signedData)
    })
    
    const result = await response.json()
    
    if (result.success) {
      const successMsg = result.message || t('successMessage')
      ElMessage.success(successMsg)
      // 更新store中的用户信息
      if (result.data) {
        store.commit('SET_USER', result.data)
      }
    } else {
      const errorMsg = result.message || result.error || t('errorSubmitFailed')
      ElMessage.error(errorMsg)
    }
  } catch (error) {
    console.error('提交错误:', error)
    
    ElMessage.error(t('errorSubmitFailed'))
  } finally {
    // 恢复按钮状态
    isSubmitting.value = false
  }
}

// 组件卸载时移除事件监听器
onBeforeUnmount(() => {
  window.removeEventListener('languagechange', handleLangChange)
})
</script>

<style scoped>
.submit-button {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 10px 32px;
  background-color: #CB261C;
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.3s ease;
  outline: none;
}

.submit-button:hover:not(:disabled) {
  background-color: #a61e16;
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(203, 38, 28, 0.3);
}

.submit-button:active:not(:disabled) {
  transform: translateY(0);
}

.submit-button:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.loading-icon {
  width: 16px;
  height: 16px;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(360deg);
  }
}
</style>
